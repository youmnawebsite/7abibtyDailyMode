<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ููุญุฉ ุงูุชุญูู - ูุฒุงุฌ ุญุจูุจุชู</title>
  <link rel="stylesheet" href="/admin-styles.css">
  <!-- ุฅุถุงูุฉ Chart.js ูุนุฑุถ ุงูุฑุณูู ุงูุจูุงููุฉ -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>ููุญุฉ ุชุญูู ูุฒุงุฌ ุญุจูุจุชู</h1>

    <!-- ุนูุงูุงุช ุงูุชุจููุจ -->
    <ul class="nav-tabs">
      <li class="active" onclick="showTab('dashboard')">ููุญุฉ ุงููุนูููุงุช</li>
      <li onclick="showTab('responses')">ุงูุฑุฏูุฏ</li>
      <li onclick="showTab('analytics')">ุงูุชุญูููุงุช</li>

      <li onclick="showTab('backups')">ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ</li>
    </ul>

    <!-- ููุญุฉ ุงููุนูููุงุช -->
    <div id="dashboard-tab" class="tab-content active">
      <div class="dashboard">
        <div class="card">
          <div class="card-header">ุฅุฌูุงูู ุงูุฑุฏูุฏ</div>
          <div class="card-body" id="total-responses">0</div>
          <div class="card-footer">ูู ุงูุฑุฏูุฏ ุงููุณุฌูุฉ</div>
        </div>

        <div class="card">
          <div class="card-header">ุฑุฏูุฏ ุงูููู</div>
          <div class="card-body" id="today-responses">0</div>
          <div class="card-footer">ุงูุฑุฏูุฏ ุงููุณุฌูุฉ ุงูููู</div>
        </div>

        <div class="card">
          <div class="card-header">ุงููุฒุงุฌ ุงูุนุงู</div>
          <div class="card-body" id="mood-indicator">๐</div>
          <div class="card-footer">ุจูุงุกู ุนูู ุขุฎุฑ ุงูุฑุฏูุฏ</div>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="mood-chart"></canvas>
      </div>

      <div class="chart-container">
        <canvas id="responses-chart"></canvas>
      </div>
    </div>

    <!-- ุงูุฑุฏูุฏ -->
    <div id="responses-tab" class="tab-content">
      <div class="controls">
        <div class="search-filters">
          <input type="text" id="search" placeholder="ุงูุจุญุซ ูู ุงูุณุคุงู ุฃู ุงูุฅุฌุงุจุฉ..." oninput="filterResponses()">
          <select id="filter-question" onchange="filterResponses()">
            <option value="">ูู ุงูุฃุณุฆูุฉ</option>
            <!-- ุณูุชู ููุคูุง ุฏููุงูููููุง -->
          </select>
          <select id="filter-mood" onchange="filterResponses()">
            <option value="">ูู ุงูุญุงูุงุช ุงููุฒุงุฌูุฉ</option>
            <option value="ูุจุณูุทู">ูุจุณูุทุฉ</option>
            <option value="ูุชุถุงููุฉ">ูุชุถุงููุฉ</option>
            <option value="ูุนูู">ูุญุงูุฏุฉ</option>
          </select>
          <input type="date" id="filter-date" onchange="filterResponses()">
        </div>

        <div class="action-buttons">
          <button onclick="clearFilters()" class="secondary-btn">ูุณุญ ุงูููุงุชุฑ</button>
          <button onclick="exportToCSV()" class="secondary-btn">ุชุตุฏูุฑ CSV</button>
          <button onclick="deleteSelectedResponses()" class="danger-btn">ุญุฐู ุงููุญุฏุฏ</button>
          <button onclick="reorderAllIds()" class="primary-btn">ุฅุนุงุฏุฉ ุชุฑุชูุจ ุงูู IDs</button>
        </div>
      </div>

      <div class="mobile-table-container">
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all" onclick="toggleSelectAll()"></th>
              <th>ID</th>
              <th>ุงูุณุคุงู</th>
              <th>ุงูุฅุฌุงุจุฉ</th>
              <th>ุงูุชุงุฑูุฎ</th>
              <th>ุงูุฅุฌุฑุงุกุงุช</th>
            </tr>
          </thead>

          <tbody id="responses">
            <!-- ุณูุชู ุชุญููู ุงูุฑุฏูุฏ ููุง -->
          </tbody>
        </table>
      </div>

      <div class="pagination">
        <button id="prev-page" onclick="changePage(-1)" disabled>ุงูุณุงุจู</button>
        <span id="page-info">ุตูุญุฉ <span id="current-page">1</span> ูู <span id="total-pages">1</span></span>
        <button id="next-page" onclick="changePage(1)" disabled>ุงูุชุงูู</button>
        <select id="page-size" onchange="changePageSize()">
          <option value="10">10 ุฑุฏูุฏ</option>
          <option value="25">25 ุฑุฏ</option>
          <option value="50">50 ุฑุฏ</option>
          <option value="100">100 ุฑุฏ</option>
        </select>
      </div>
    </div>

    <!-- ุงูุชุญูููุงุช -->
    <div id="analytics-tab" class="tab-content">
      <h2>ุชุญูููุงุช ุงููุฒุงุฌ</h2>

      <div class="chart-container">
        <canvas id="mood-distribution-chart"></canvas>
      </div>

      <div class="chart-container">
        <canvas id="mood-trend-chart"></canvas>
      </div>

      <div class="stats">
        <h3>ุฅุญุตุงุฆูุงุช ุงูุฃุณุฆูุฉ</h3>
        <ul id="stats-list"></ul>
      </div>

      <div class="stats">
        <h3>ุงููููุงุช ุงูุฃูุซุฑ ุชูุฑุงุฑูุง</h3>
        <ul id="common-words"></ul>
      </div>
    </div>



    <!-- ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ -->
    <div id="backups-tab" class="tab-content">
      <h2>ุฅุฏุงุฑุฉ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ููุชุณุฌููุงุช ุงูุตูุชูุฉ</h2>

      <div class="controls">
        <div class="action-buttons">
          <button onclick="checkAudioFiles()" class="primary-btn">ูุญุต ูููุงุช ุงูุตูุช</button>
          <button onclick="loadBackups()" class="secondary-btn">ุชุญุฏูุซ ูุงุฆูุฉ ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ</button>
        </div>
      </div>

      <div class="backup-section">
        <h3>ุญุงูุฉ ูููุงุช ุงูุตูุช</h3>
        <div id="audio-status" class="status-container">
          <p>ุงุถุบุท ุนูู ุฒุฑ "ูุญุต ูููุงุช ุงูุตูุช" ูุนุฑุถ ุญุงูุฉ ุงููููุงุช.</p>
        </div>

        <div id="missing-files-container" style="display: none;">
          <h3>ุงููููุงุช ุงูููููุฏุฉ</h3>
          <div class="mobile-table-container">
            <table id="missing-files-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>ุงููุณุงุฑ</th>
                  <th>ุงูุชุงุฑูุฎ</th>
                  <th>ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ</th>
                  <th>ุงูุฅุฌุฑุงุกุงุช</th>
                </tr>
              </thead>
              <tbody id="missing-files">
                <!-- ุณูุชู ููุคูุง ุฏููุงูููููุง -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="backup-section">
        <h3>ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุงููุชููุฑุฉ</h3>
        <div class="mobile-table-container">
          <table>
            <thead>
              <tr>
                <th>ุงุณู ุงูููู</th>
                <th>ุงูุญุฌู</th>
                <th>ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                <th>ุงูุฅุฌุฑุงุกุงุช</th>
              </tr>
            </thead>
            <tbody id="backups-list">
              <!-- ุณูุชู ููุคูุง ุฏููุงูููููุง -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for updating response -->
<!-- ูุฑุจุน ุญูุงุฑ ุชุญุฏูุซ ุงูุฑุฏ -->
<div class="modal" id="updateModal">
  <div class="modal-content">
    <h2>ุชุญุฏูุซ ุงูุฑุฏ</h2>
    <input type="text" id="update-id" placeholder="ุฑูู ุงูุชุนุฑูู ุงูุฌุฏูุฏ">
    <input type="text" id="update-answer" placeholder="ุงูุฅุฌุงุจุฉ ุงูุฌุฏูุฏุฉ">
    <input type="datetime-local" id="update-timestamp">
    <div class="modal-buttons">
      <button onclick="submitUpdate()">ุชุญุฏูุซ</button>
      <button onclick="closeModal()" class="cancel">ุฅูุบุงุก</button>
    </div>
  </div>
</div>



  <script>
    let allResponses = [];
    let currentResponseId = null;
    let charts = {}; // ูุชุฎุฒูู ูุฑุงุฌุน ุงูุฑุณูู ุงูุจูุงููุฉ
    let uniqueQuestions = []; // ูุชุฎุฒูู ุงูุฃุณุฆูุฉ ุงููุฑูุฏุฉ


    // ุชุญููู ุงูุจูุงูุงุช ุนูุฏ ุชุญููู ุงูุตูุญุฉ
    window.onload = function() {
      loadResponses();

      loadBackups();

      // ุชุนููู ุงูุชุงุฑูุฎ ุงูุงูุชุฑุงุถู ูููุชุฑ ุงูุชุงุฑูุฎ ููููู ุงูููู
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('filter-date').value = '';

      // ุฅุถุงูุฉ ูุณุชูุน ููุชุจููุจ
      document.querySelectorAll('.nav-tabs li').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.getAttribute('onclick').match(/'([^']+)'/)[1];
          if (tabName === 'backups') {
            loadBackups();
          }
        });
      });
    };

    // ุนุฑุถ ุนูุงูุฉ ุชุจููุจ ูุญุฏุฏุฉ
    function showTab(tabName) {
      // ุฅุฎูุงุก ุฌููุน ุนูุงูุงุช ุงูุชุจููุจ
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });

      // ุฅุฒุงูุฉ ุงููุฆุฉ ุงููุดุทุฉ ูู ุฌููุน ุนูุงุตุฑ ุงููุงุฆูุฉ
      document.querySelectorAll('.nav-tabs li').forEach(item => {
        item.classList.remove('active');
      });

      // ุฅุธูุงุฑ ุนูุงูุฉ ุงูุชุจููุจ ุงููุญุฏุฏุฉ
      document.getElementById(tabName + '-tab').classList.add('active');

      // ุชุญุฏูุฏ ุนูุตุฑ ุงููุงุฆูุฉ ุงูููุงุณุจ
      document.querySelector(`.nav-tabs li[onclick="showTab('${tabName}')"]`).classList.add('active');

      // ุชุญุฏูุซ ุงูุฑุณูู ุงูุจูุงููุฉ ุฅุฐุง ูุงูุช ุนูุงูุฉ ุงูุชุจููุจ ูู ููุญุฉ ุงููุนูููุงุช ุฃู ุงูุชุญูููุงุช
      if (tabName === 'dashboard' || tabName === 'analytics') {
        updateCharts();
      }
    }

    // ุชุญููู ุงูุฑุฏูุฏ ูู ุงูุฎุงุฏู
    function loadResponses() {
      fetch('/api/responses')
        .then(res => res.json())
        .then(data => {
          allResponses = data;

          // ุงุณุชุฎุฑุงุฌ ุงูุฃุณุฆูุฉ ุงููุฑูุฏุฉ
          uniqueQuestions = [...new Set(data.map(response => response.question))];

          // ููุก ูุงุฆูุฉ ุงูุฃุณุฆูุฉ ูู ุงูููุชุฑ
          const filterQuestion = document.getElementById('filter-question');
          filterQuestion.innerHTML = '<option value="">ูู ุงูุฃุณุฆูุฉ</option>';
          uniqueQuestions.forEach(question => {
            const option = document.createElement('option');
            option.value = question;
            option.textContent = question;
            filterQuestion.appendChild(option);
          });

          renderResponses(data);
          updateStats();
          updateDashboard();
          updateCharts();
        })
        .catch(error => {
          console.error('Error loading responses:', error);
        });
    }

    // ุชุญุฏูุซ ููุญุฉ ุงููุนูููุงุช
    function updateDashboard() {
      if (!allResponses || allResponses.length === 0) return;

      // ุฅุฌูุงูู ุงูุฑุฏูุฏ
      document.getElementById('total-responses').textContent = allResponses.length;

      // ุฑุฏูุฏ ุงูููู
      const today = new Date().toISOString().split('T')[0];
      const todayResponses = allResponses.filter(response =>
        response.timestamp.startsWith(today)
      ).length;
      document.getElementById('today-responses').textContent = todayResponses;

      // ุงููุฒุงุฌ ุงูุนุงู
      const moodIndicator = getMoodIndicator();
      document.getElementById('mood-indicator').textContent = moodIndicator;
    }

    // ุชุญุฏูุซ ุงูุฑุณูู ุงูุจูุงููุฉ
    function updateCharts() {
      // ุชูุธูู ุงูุฑุณูู ุงูุจูุงููุฉ ุงููุฏููุฉ
      Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
      });

      // ุฅูุดุงุก ุฑุณู ุจูุงูู ูููุฒุงุฌ
      createMoodChart();

      // ุฅูุดุงุก ุฑุณู ุจูุงูู ููุฑุฏูุฏ
      createResponsesChart();

      // ุฅูุดุงุก ุฑุณู ุจูุงูู ูุชูุฒูุน ุงููุฒุงุฌ
      createMoodDistributionChart();

      // ุฅูุดุงุก ุฑุณู ุจูุงูู ูุงุชุฌุงู ุงููุฒุงุฌ
      createMoodTrendChart();

      // ุชุญุฏูุซ ูุงุฆูุฉ ุงููููุงุช ุงูุดุงุฆุนุฉ
      updateCommonWords();
    }

    // ุฅูุดุงุก ุฑุณู ุจูุงูู ูููุฒุงุฌ
    function createMoodChart() {
      const ctx = document.getElementById('mood-chart').getContext('2d');

      // ุชุญููู ุจูุงูุงุช ุงููุฒุงุฌ
      const moodData = analyzeMoodData();

      charts.mood = new Chart(ctx, {
        type: 'line',
        data: {
          labels: moodData.labels,
          datasets: [{
            label: 'ูุณุชูู ุงููุฒุงุฌ',
            data: moodData.data,
            backgroundColor: 'rgba(108, 92, 231, 0.2)',
            borderColor: 'rgba(108, 92, 231, 1)',
            borderWidth: 2,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'ุชุบูุฑ ุงููุฒุงุฌ ุฎูุงู ุงูุฃุณุจูุน ุงููุงุถู',
              font: {
                size: 16
              }
            },
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 10,
              title: {
                display: true,
                text: 'ูุณุชูู ุงููุฒุงุฌ (1-10)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'ุงูุชุงุฑูุฎ'
              }
            }
          }
        }
      });
    }

    // ุฅูุดุงุก ุฑุณู ุจูุงูู ููุฑุฏูุฏ
    function createResponsesChart() {
      const ctx = document.getElementById('responses-chart').getContext('2d');

      // ุชุญููู ุจูุงูุงุช ุงูุฑุฏูุฏ
      const responseData = analyzeResponseData();

      charts.responses = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: responseData.labels,
          datasets: [{
            label: 'ุนุฏุฏ ุงูุฑุฏูุฏ',
            data: responseData.data,
            backgroundColor: 'rgba(253, 121, 168, 0.6)',
            borderColor: 'rgba(253, 121, 168, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'ุนุฏุฏ ุงูุฑุฏูุฏ ุญุณุจ ุงูููู',
              font: {
                size: 16
              }
            },
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'ุนุฏุฏ ุงูุฑุฏูุฏ'
              }
            },
            x: {
              title: {
                display: true,
                text: 'ุงูููู'
              }
            }
          }
        }
      });
    }

    // ุฅูุดุงุก ุฑุณู ุจูุงูู ูุชูุฒูุน ุงููุฒุงุฌ
    function createMoodDistributionChart() {
      const ctx = document.getElementById('mood-distribution-chart').getContext('2d');

      // ุชุญููู ุชูุฒูุน ุงููุฒุงุฌ
      const moodDistribution = analyzeMoodDistribution();

      charts.moodDistribution = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: moodDistribution.labels,
          datasets: [{
            data: moodDistribution.data,
            backgroundColor: [
              'rgba(0, 184, 148, 0.6)',
              'rgba(253, 203, 110, 0.6)',
              'rgba(231, 76, 60, 0.6)',
              'rgba(108, 92, 231, 0.6)'
            ],
            borderColor: [
              'rgba(0, 184, 148, 1)',
              'rgba(253, 203, 110, 1)',
              'rgba(231, 76, 60, 1)',
              'rgba(108, 92, 231, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'ุชูุฒูุน ุงููุฒุงุฌ',
              font: {
                size: 16
              }
            },
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // ุฅูุดุงุก ุฑุณู ุจูุงูู ูุงุชุฌุงู ุงููุฒุงุฌ
    function createMoodTrendChart() {
      const ctx = document.getElementById('mood-trend-chart').getContext('2d');

      // ุชุญููู ุงุชุฌุงู ุงููุฒุงุฌ
      const moodTrend = analyzeMoodTrend();

      charts.moodTrend = new Chart(ctx, {
        type: 'line',
        data: {
          labels: moodTrend.labels,
          datasets: moodTrend.datasets
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'ุงุชุฌุงู ุงููุฒุงุฌ ุญุณุจ ุงูุณุคุงู',
              font: {
                size: 16
              }
            },
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 10,
              title: {
                display: true,
                text: 'ูุณุชูู ุงููุฒุงุฌ (1-10)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'ุงูุชุงุฑูุฎ'
              }
            }
          }
        }
      });
    }

    // ุชุญููู ุจูุงูุงุช ุงููุฒุงุฌ
    function analyzeMoodData() {
      // ุงูุญุตูู ุนูู ุงูุฃูุงู ุงูุณุจุนุฉ ุงููุงุถูุฉ
      const dates = [];
      const data = [];

      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateString = date.toISOString().split('T')[0];
        dates.push(dateString);

        // ุญุณุงุจ ูุชูุณุท ุงููุฒุงุฌ ููุฐุง ุงูููู
        const dayResponses = allResponses.filter(response =>
          response.timestamp.startsWith(dateString)
        );

        if (dayResponses.length > 0) {
          const moodScore = calculateMoodScore(dayResponses);
          data.push(moodScore);
        } else {
          data.push(null); // ูุง ุชูุฌุฏ ุจูุงูุงุช ููุฐุง ุงูููู
        }
      }

      return {
        labels: dates.map(date => formatDate(date)),
        data: data
      };
    }

    // ุชุญููู ุจูุงูุงุช ุงูุฑุฏูุฏ
    function analyzeResponseData() {
      // ุงูุญุตูู ุนูู ุงูุฃูุงู ุงูุณุจุนุฉ ุงููุงุถูุฉ
      const dates = [];
      const data = [];

      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateString = date.toISOString().split('T')[0];
        dates.push(dateString);

        // ุญุณุงุจ ุนุฏุฏ ุงูุฑุฏูุฏ ููุฐุง ุงูููู
        const dayResponses = allResponses.filter(response =>
          response.timestamp.startsWith(dateString)
        ).length;

        data.push(dayResponses);
      }

      return {
        labels: dates.map(date => formatDate(date)),
        data: data
      };
    }

    // ุชุญููู ุชูุฒูุน ุงููุฒุงุฌ
    function analyzeMoodDistribution() {
      const moodCounts = {
        'ูุจุณูุทุฉ': 0,
        'ูุญุงูุฏุฉ': 0,
        'ูุชุถุงููุฉ': 0,
        'ุฃุฎุฑู': 0
      };

      allResponses.forEach(response => {
        if (response.answer.includes('ูุจุณูุทู')) {
          moodCounts['ูุจุณูุทุฉ']++;
        } else if (response.answer.includes('ูุนูู ุดููู')) {
          moodCounts['ูุญุงูุฏุฉ']++;
        } else if (response.answer.includes('ูุชุถุงููุฉ') || response.answer.includes('ูุด ูุจุณูุทู')) {
          moodCounts['ูุชุถุงููุฉ']++;
        } else {
          moodCounts['ุฃุฎุฑู']++;
        }
      });

      return {
        labels: Object.keys(moodCounts),
        data: Object.values(moodCounts)
      };
    }

    // ุชุญููู ุงุชุฌุงู ุงููุฒุงุฌ
    function analyzeMoodTrend() {
      // ุงูุญุตูู ุนูู ุงูุฃูุงู ุงูุณุจุนุฉ ุงููุงุถูุฉ
      const dates = [];

      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateString = date.toISOString().split('T')[0];
        dates.push(dateString);
      }

      // ุฅูุดุงุก ูุฌููุนุงุช ุงูุจูุงูุงุช ููู ุณุคุงู
      const datasets = [];
      const colors = [
        'rgba(108, 92, 231, 1)',
        'rgba(253, 121, 168, 1)',
        'rgba(0, 184, 148, 1)',
        'rgba(253, 203, 110, 1)'
      ];

      uniqueQuestions.forEach((question, index) => {
        const data = [];

        dates.forEach(date => {
          // ุงูุญุตูู ุนูู ุงูุฑุฏูุฏ ููุฐุง ุงูุณุคุงู ูู ูุฐุง ุงูููู
          const dayResponses = allResponses.filter(response =>
            response.timestamp.startsWith(date) && response.question === question
          );

          if (dayResponses.length > 0) {
            const moodScore = calculateMoodScore(dayResponses);
            data.push(moodScore);
          } else {
            data.push(null); // ูุง ุชูุฌุฏ ุจูุงูุงุช ููุฐุง ุงูููู
          }
        });

        datasets.push({
          label: question,
          data: data,
          borderColor: colors[index % colors.length],
          backgroundColor: colors[index % colors.length].replace('1)', '0.2)'),
          borderWidth: 2,
          tension: 0.3
        });
      });

      return {
        labels: dates.map(date => formatDate(date)),
        datasets: datasets
      };
    }

    // ุญุณุงุจ ุฏุฑุฌุฉ ุงููุฒุงุฌ
    function calculateMoodScore(responses) {
      let totalScore = 0;
      let count = 0;

      responses.forEach(response => {
        let score = 5; // ูููุฉ ุงูุชุฑุงุถูุฉ ูุญุงูุฏุฉ

        if (response.answer.includes('ูุจุณูุทู')) {
          score = 8;
        } else if (response.answer.includes('ูุนูู ุดููู')) {
          score = 5;
        } else if (response.answer.includes('ูุชุถุงููุฉ') || response.answer.includes('ูุด ูุจุณูุทู')) {
          score = 2;
        }

        totalScore += score;
        count++;
      });

      return count > 0 ? totalScore / count : 5;
    }

    // ุงูุญุตูู ุนูู ูุคุดุฑ ุงููุฒุงุฌ
    function getMoodIndicator() {
      if (!allResponses || allResponses.length === 0) return '๐';

      // ุงูุญุตูู ุนูู ุขุฎุฑ 5 ุฑุฏูุฏ
      const recentResponses = allResponses.slice(0, 5);
      const moodScore = calculateMoodScore(recentResponses);

      if (moodScore >= 7) {
        return '๐';
      } else if (moodScore >= 4) {
        return '๐';
      } else {
        return '๐';
      }
    }

    // ุชุญุฏูุซ ูุงุฆูุฉ ุงููููุงุช ุงูุดุงุฆุนุฉ
    function updateCommonWords() {
      // ุฌูุน ุฌููุน ุงูุฅุฌุงุจุงุช ุงููุตูุฉ
      const textAnswers = allResponses
        .filter(response => !isAudioFile(response.answer))
        .map(response => response.answer);

      // ุชุญููู ุงููููุงุช ุงูุดุงุฆุนุฉ
      const wordCounts = {};
      const stopWords = ['ูู', 'ูู', 'ุนูู', 'ุฅูู', 'ุนู', 'ูุน', 'ูุฐุง', 'ูุฐู', 'ุฐูู', 'ุชูู', 'ูู', 'ูู', 'ุฃูุง', 'ุฃูุช', 'ูุญู', 'ูู'];

      textAnswers.forEach(answer => {
        const words = answer.split(/\s+/);
        words.forEach(word => {
          word = word.replace(/[^\p{L}\p{N}]/gu, '').trim().toLowerCase();
          if (word && word.length > 1 && !stopWords.includes(word)) {
            wordCounts[word] = (wordCounts[word] || 0) + 1;
          }
        });
      });

      // ุชุฑุชูุจ ุงููููุงุช ุญุณุจ ุงูุชูุฑุงุฑ
      const sortedWords = Object.entries(wordCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      // ุนุฑุถ ุงููููุงุช ุงูุดุงุฆุนุฉ
      const commonWordsList = document.getElementById('common-words');
      commonWordsList.innerHTML = '';

      sortedWords.forEach(([word, count]) => {
        const li = document.createElement('li');
        li.textContent = `${word}: ${count} ูุฑุฉ`;
        commonWordsList.appendChild(li);
      });
    }

    // ุชูุณูู ุงูุชุงุฑูุฎ
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('ar-EG', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    // ุงูุชุญูู ููุง ุฅุฐุง ูุงูุช ุงูุฅุฌุงุจุฉ ูู ููู ุตูุชู
    function isAudioFile(answer) {
      if (!answer) return false;
      return answer.startsWith('/uploads/') || /\.(mp3|wav|ogg|webm|audio)$/i.test(answer);
    }

    // ุงูุญุตูู ุนูู ููุน MIME ุงูููุงุณุจ ููููุงุช ุงูุตูุช
    function getAudioMimeType(filePath) {
      if (!filePath) return 'audio/mpeg';
      if (filePath.endsWith('.mp3')) return 'audio/mpeg';
      if (filePath.endsWith('.wav')) return 'audio/wav';
      if (filePath.endsWith('.ogg')) return 'audio/ogg';
      if (filePath.endsWith('.webm')) return 'audio/webm';
      return 'audio/mpeg'; // ูููุฉ ุงูุชุฑุงุถูุฉ
    }

    // ูุชุบูุฑุงุช ุงูุชุฑููู
    let currentPage = 1;
    let pageSize = 10;
    let filteredResponses = [];

    // ุนุฑุถ ุงูุฑุฏูุฏ
    function renderResponses(data) {
      filteredResponses = [...data]; // ุญูุธ ุงูุจูุงูุงุช ุงููุตูุงุฉ ููุชุฑููู

      // ุชุทุจูู ุงูุชุฑููู
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const paginatedData = data.slice(startIndex, endIndex);

      // ุชุญุฏูุซ ูุนูููุงุช ุงูุชุฑููู
      updatePagination(data.length);

      const tbody = document.getElementById('responses');
      tbody.innerHTML = '';

      if (data.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="6" style="text-align: center;">ูุง ุชูุฌุฏ ุฑุฏูุฏ ูุชุงุญุฉ</td>`;
        tbody.appendChild(row);
        return;
      }

      paginatedData.forEach(response => {
        const row = document.createElement('tr');
        const formattedDate = new Date(response.timestamp).toLocaleString('ar-EG');

        // ุงูุชุญูู ููุง ุฅุฐุง ูุงู ููู ุตูุชู
        const isAudio = isAudioFile(response.answer);
        const audioMimeType = isAudio ? getAudioMimeType(response.answer) : '';

        // ุชุญุฏูุฏ ููู ุงูุฎูููุฉ ุจูุงุกู ุนูู ุงููุฒุงุฌ
        let rowClass = '';
        if (response.answer.includes('ูุจุณูุทู')) {
          rowClass = 'background-color: rgba(0, 184, 148, 0.1);';
        } else if (response.answer.includes('ูุชุถุงููุฉ') || response.answer.includes('ูุด ูุจุณูุทู')) {
          rowClass = 'background-color: rgba(231, 76, 60, 0.1);';
        } else if (response.answer.includes('ูุนูู ุดููู')) {
          rowClass = 'background-color: rgba(253, 203, 110, 0.1);';
        }

        row.style = rowClass;
        row.innerHTML = `
          <td><input type="checkbox" class="select-response" value="${response.id}"></td>
          <td>${response.id}</td>
          <td>${response.question}</td>
          <td>
            ${isAudio ?
              `<div class="audio-player" data-src="${response.answer}" data-type="${audioMimeType}">
                <div class="custom-audio-player">
                  <div class="audio-progress-container">
                    <div class="audio-progress-bar"></div>
                  </div>
                  <div class="audio-controls">
                    <div class="audio-buttons">
                      <button class="play-btn" title="ุชุดุบูู">โถ๏ธ</button>
                      <button class="pause-btn" title="ุฅููุงู ูุคูุช" style="display:none;">โธ๏ธ</button>
                      <button class="stop-btn" title="ุฅููุงู">โน๏ธ</button>
                    </div>
                    <div class="audio-time">
                      <span class="current-time">00:00</span> / <span class="total-time">00:00</span>
                    </div>
                    <div class="audio-volume">
                      <span>๐</span>
                      <input type="range" min="0" max="1" step="0.1" value="1" class="volume-control">
                    </div>
                  </div>
                </div>
                <div class="audio-player-controls">
                  <a href="${response.answer}" download="${response.id}_audio${getFileExtension(response.answer)}" title="ุชุญููู ุงูููู ุงูุตูุชู" class="download-btn">โฌ๏ธ ุชุญููู</a>
                </div>
              </div>`
              : response.answer}
          </td>
          <td>${formattedDate}</td>
          <td>
            <button class="delete-btn" onclick="deleteResponse(${response.id})">ุญุฐู</button>
            <button class="edit-btn" onclick="openUpdateModal(${response.id})">ุชุนุฏูู</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // ุชุญุณูู ูุดุบู ุงูุตูุช
      enhanceAudioPlayers();
    }

    // ุชุญุณูู ูุดุบูุงุช ุงูุตูุช
    function enhanceAudioPlayers() {
      // ุชููุฆุฉ ุฌููุน ูุดุบูุงุช ุงูุตูุช ุงููุฎุตุตุฉ
      document.querySelectorAll('.audio-player').forEach(playerContainer => {
        const audioSrc = playerContainer.getAttribute('data-src');
        const audioType = playerContainer.getAttribute('data-type');

        if (!audioSrc) return;

        // ุฅูุดุงุก ุนูุตุฑ ุงูุตูุช
        const audio = new Audio();
        audio.src = audioSrc;
        audio.preload = 'metadata';

        // ุงูุญุตูู ุนูู ุนูุงุตุฑ ุงูุชุญูู
        const playBtn = playerContainer.querySelector('.play-btn');
        const pauseBtn = playerContainer.querySelector('.pause-btn');
        const stopBtn = playerContainer.querySelector('.stop-btn');
        const progressBar = playerContainer.querySelector('.audio-progress-bar');
        const progressContainer = playerContainer.querySelector('.audio-progress-container');
        const currentTimeDisplay = playerContainer.querySelector('.current-time');
        const totalTimeDisplay = playerContainer.querySelector('.total-time');
        const volumeControl = playerContainer.querySelector('.volume-control');

        // ุชุนููู ูุณุชูู ุงูุตูุช ุงูุฃูุตู
        audio.volume = 1.0;

        // ุชุญููู ุงูุจูุงูุงุช ุงููุตููุฉ ููุตูุช
        audio.addEventListener('loadedmetadata', () => {
          totalTimeDisplay.textContent = formatTime(audio.duration);
        });

        // ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู ูุงูููุช ุงูุญุงูู
        audio.addEventListener('timeupdate', () => {
          const progress = (audio.currentTime / audio.duration) * 100;
          progressBar.style.width = `${progress}%`;
          currentTimeDisplay.textContent = formatTime(audio.currentTime);
        });

        // ุชุดุบูู ุงูุตูุช
        playBtn.addEventListener('click', () => {
          // ุฅููุงู ุฌููุน ูุดุบูุงุช ุงูุตูุช ุงูุฃุฎุฑู
          document.querySelectorAll('.audio-player').forEach(otherPlayer => {
            if (otherPlayer !== playerContainer) {
              const otherPlayBtn = otherPlayer.querySelector('.play-btn');
              const otherPauseBtn = otherPlayer.querySelector('.pause-btn');
              if (otherPlayBtn && otherPauseBtn) {
                otherPlayBtn.style.display = 'block';
                otherPauseBtn.style.display = 'none';
              }
            }
          });

          // ุชุญููู ุงูุตูุช ูุฑุฉ ุฃุฎุฑู ููุชุฃูุฏ ูู ุชุญุฏูุซู
          audio.load();

          // ุฅุถุงูุฉ ูุนุงูุฌ ุฃุญุฏุงุซ ูุญุงูุฉ ุงูุฎุทุฃ
          audio.onerror = function(e) {
            console.error('Audio error:', e);
            console.error('Audio error code:', audio.error ? audio.error.code : 'unknown');
            console.error('Audio src:', audio.src);

            // ูุญุงููุฉ ุฅุตูุงุญ ุงููุณุงุฑ
            if (audio.src.startsWith(window.location.origin)) {
              // ุงููุณุงุฑ ูุทููุ ูุง ุฏุงุนู ููุชุบููุฑ
            } else {
              // ุชุญููู ุงููุณุงุฑ ุงููุณุจู ุฅูู ูุทูู
              const fixedSrc = window.location.origin + audioSrc;
              console.log('Trying fixed path:', fixedSrc);
              audio.src = fixedSrc;
              audio.load();
            }
          };

          // ุชุดุบูู ุงูุตูุช ุงูุญุงูู
          const playPromise = audio.play();

          if (playPromise !== undefined) {
            playPromise.catch(error => {
              console.error('Error playing audio:', error);

              // ูุญุงููุฉ ุฅุตูุงุญ ุงููุณุงุฑ ูุฅุนุงุฏุฉ ุงูุชุดุบูู
              if (!audio.src.startsWith(window.location.origin)) {
                const fixedSrc = window.location.origin + audioSrc;
                console.log('Trying fixed path on error:', fixedSrc);
                audio.src = fixedSrc;
                audio.load();
                audio.play().catch(e => {
                  console.error('Still failed after path fix:', e);
                  alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุดุบูู ุงูุตูุช. ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
                });
              } else {
                alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุดุบูู ุงูุตูุช. ูุฑุฌู ุงูุชุญูู ูู ุงุชุตุงู ุงูุฅูุชุฑูุช ูุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.');
              }
            });
          }

          // ุชุจุฏูู ุงูุฃุฒุฑุงุฑ
          playBtn.style.display = 'none';
          pauseBtn.style.display = 'block';
        });

        // ุฅููุงู ุงูุตูุช ูุคูุชูุง
        pauseBtn.addEventListener('click', () => {
          audio.pause();

          // ุชุจุฏูู ุงูุฃุฒุฑุงุฑ
          playBtn.style.display = 'block';
          pauseBtn.style.display = 'none';
        });

        // ุฅููุงู ุงูุตูุช
        stopBtn.addEventListener('click', () => {
          audio.pause();
          audio.currentTime = 0;

          // ุชุจุฏูู ุงูุฃุฒุฑุงุฑ
          playBtn.style.display = 'block';
          pauseBtn.style.display = 'none';
        });

        // ุงูุชุญูู ูู ูุณุชูู ุงูุตูุช
        volumeControl.addEventListener('input', () => {
          audio.volume = volumeControl.value;
        });

        // ุงูุชุญูู ูู ุงูุชูุฏู ุจุงูููุฑ ุนูู ุดุฑูุท ุงูุชูุฏู
        progressContainer.addEventListener('click', (event) => {
          const rect = progressContainer.getBoundingClientRect();
          const clickPosition = (event.clientX - rect.left) / rect.width;
          audio.currentTime = clickPosition * audio.duration;
        });

        // ุฅุนุงุฏุฉ ุชุนููู ุนูุฏ ุงูุชูุงุก ุงูุตูุช
        audio.addEventListener('ended', () => {
          audio.currentTime = 0;
          playBtn.style.display = 'block';
          pauseBtn.style.display = 'none';
        });
      });
    }

    // ุชูุณูู ุงูููุช (ุซูุงูู ุฅูู mm:ss)
    function formatTime(seconds) {
      if (isNaN(seconds)) return '00:00';

      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);

      return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    // ุงูุญุตูู ุนูู ุงูุชุฏุงุฏ ุงูููู ูู ุงููุณุงุฑ
    function getFileExtension(filePath) {
      if (!filePath) return '.mp3';

      const extensions = ['.mp3', '.wav', '.ogg', '.webm', '.audio'];

      for (const ext of extensions) {
        if (filePath.toLowerCase().endsWith(ext)) {
          return ext;
        }
      }

      return '.mp3'; // ุงูุชุฏุงุฏ ุงูุชุฑุงุถู
    }

    // ุชุญุฏูุซ ูุนูููุงุช ุงูุชุฑููู
    function updatePagination(totalItems) {
      const totalPages = Math.ceil(totalItems / pageSize);

      document.getElementById('current-page').textContent = currentPage;
      document.getElementById('total-pages').textContent = totalPages;

      // ุชุญุฏูุซ ุญุงูุฉ ุฃุฒุฑุงุฑ ุงูุชููู
      document.getElementById('prev-page').disabled = currentPage <= 1;
      document.getElementById('next-page').disabled = currentPage >= totalPages;

      // ุชุญุฏูุซ ุญุฌู ุงูุตูุญุฉ ุงููุญุฏุฏ
      document.getElementById('page-size').value = pageSize;
    }

    // ุชุบููุฑ ุงูุตูุญุฉ
    function changePage(delta) {
      currentPage += delta;
      renderResponses(filteredResponses);
    }

    // ุชุบููุฑ ุญุฌู ุงูุตูุญุฉ
    function changePageSize() {
      pageSize = parseInt(document.getElementById('page-size').value);
      currentPage = 1; // ุงูุนูุฏุฉ ุฅูู ุงูุตูุญุฉ ุงูุฃููู ุนูุฏ ุชุบููุฑ ุญุฌู ุงูุตูุญุฉ
      renderResponses(filteredResponses);
    }

    // ุฅุนุงุฏุฉ ุชุฑุชูุจ ุฌููุน ุงูู IDs
    function reorderAllIds() {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุฅุนุงุฏุฉ ุชุฑุชูุจ ุฌููุน ุงูู IDsุ ุณูุชู ุชุฑุชูุจูุง ุจุดูู ุชุณูุณูู ูู 1.')) return;

      // ุฅูุดุงุก ูุณุฎุฉ ูุฑุชุจุฉ ูู ุงูุฑุฏูุฏ ุญุณุจ ุงูุชุงุฑูุฎ
      const sortedResponses = [...allResponses].sort((a, b) =>
        new Date(a.timestamp) - new Date(b.timestamp)
      );

      // ุฅูุดุงุก ูุตูููุฉ ูู ุงูุชุญุฏูุซุงุช
      const updates = sortedResponses.map((response, index) => ({
        id: response.id,
        newId: index + 1
      }));

      // ุฅุฑุณุงู ุทูุจ ุงูุชุญุฏูุซ
      fetch('/api/reorder-ids', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ updates })
      })
      .then(response => {
        if (response.ok) {
          alert('ุชู ุฅุนุงุฏุฉ ุชุฑุชูุจ ุงูู IDs ุจูุฌุงุญ!');
          loadResponses();
        } else {
          throw new Error('ูุดู ุฅุนุงุฏุฉ ุชุฑุชูุจ ุงูู IDs');
        }
      })
      .catch(error => {
        console.error('Error reordering IDs:', error);
        alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุนุงุฏุฉ ุชุฑุชูุจ ุงูู IDs. ุณูููู ุจุชุญุฏูุซ ุงูู IDs ูุญูููุง.');

        // ุชุญุฏูุซ ุงูู IDs ูุญูููุง ุฅุฐุง ูุดู ุงูุทูุจ
        updateIdsLocally(updates);
      });
    }

    // ุชุญุฏูุซ ุงูู IDs ูุญูููุง
    function updateIdsLocally(updates) {
      // ุชุญุฏูุซ ุงูู IDs ูู ุงูุฐุงูุฑุฉ
      updates.forEach(update => {
        const response = allResponses.find(r => r.id === update.id);
        if (response) {
          response.id = update.newId;
        }
      });

      // ุฅุนุงุฏุฉ ุนุฑุถ ุงูุฑุฏูุฏ
      renderResponses(filteredResponses);

      alert('ุชู ุชุญุฏูุซ ุงูู IDs ูุญูููุง. ูุฏ ุชุญุชุงุฌ ุฅูู ุฅุนุงุฏุฉ ุชุญููู ุงูุตูุญุฉ ูุฑุคูุฉ ุงูุชุบููุฑุงุช ุจุดูู ูุงูู.');
    }

    // ุชุตููุฉ ุงูุฑุฏูุฏ
    function filterResponses() {
      const search = document.getElementById('search').value.toLowerCase();
      const filterDate = document.getElementById('filter-date').value;
      const filterQuestion = document.getElementById('filter-question').value;
      const filterMood = document.getElementById('filter-mood').value;

      let filtered = allResponses;

      // ุชุตููุฉ ุญุณุจ ุงูุจุญุซ ุงููุตู
      if (search) {
        filtered = filtered.filter(
          response =>
            response.question.toLowerCase().includes(search) ||
            response.answer.toLowerCase().includes(search) ||
            response.id.toString().includes(search)
        );
      }

      // ุชุตููุฉ ุญุณุจ ุงูุชุงุฑูุฎ
      if (filterDate) {
        filtered = filtered.filter(response =>
          response.timestamp.startsWith(filterDate)
        );
      }

      // ุชุตููุฉ ุญุณุจ ุงูุณุคุงู
      if (filterQuestion) {
        filtered = filtered.filter(response =>
          response.question === filterQuestion
        );
      }

      // ุชุตููุฉ ุญุณุจ ุงููุฒุงุฌ
      if (filterMood) {
        filtered = filtered.filter(response => {
          if (filterMood === 'ูุจุณูุทู' && response.answer.includes('ูุจุณูุทู')) {
            return true;
          } else if (filterMood === 'ูุชุถุงููุฉ' && (response.answer.includes('ูุชุถุงููุฉ') || response.answer.includes('ูุด ูุจุณูุทู'))) {
            return true;
          } else if (filterMood === 'ูุนูู' && response.answer.includes('ูุนูู ุดููู')) {
            return true;
          }
          return false;
        });
      }

      // ุฅุนุงุฏุฉ ุชุนููู ุงูุตูุญุฉ ุงูุญุงููุฉ ุนูุฏ ุชุบููุฑ ุงูููุชุฑ
      currentPage = 1;

      // ุนุฑุถ ุงููุชุงุฆุฌ ุงููุตูุงุฉ
      renderResponses(filtered);
    }

    // ูุณุญ ุงูููุงุชุฑ
    function clearFilters() {
      document.getElementById('search').value = '';
      document.getElementById('filter-date').value = '';
      document.getElementById('filter-question').value = '';
      document.getElementById('filter-mood').value = '';

      // ุฅุนุงุฏุฉ ุชุนููู ุงูุตูุญุฉ ุงูุญุงููุฉ
      currentPage = 1;

      renderResponses(allResponses);
    }

    // ุญุฐู ุฑุฏ
    function deleteResponse(id) {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ูุฐุง ุงูุฑุฏุ')) return;

      fetch('/api/responses/' + id, { method: 'DELETE' })
        .then(res => {
          if (res.ok) {
            alert('ุชู ุญุฐู ุงูุฑุฏ ุจูุฌุงุญ!');
            loadResponses();
          } else {
            alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุฑุฏ.');
          }
        })
        .catch(error => {
          console.error('Error deleting response:', error);
          alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุฑุฏ.');
        });
    }

    // ุญุฐู ุฌููุน ุงูุฑุฏูุฏ
    function deleteAllResponses() {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุฌููุน ุงูุฑุฏูุฏุ ูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู!')) return;

      fetch('/api/responses', { method: 'DELETE' })
        .then(res => {
          if (res.ok) {
            alert('ุชู ุญุฐู ุฌููุน ุงูุฑุฏูุฏ ุจูุฌุงุญ!');
            loadResponses();
          } else {
            alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุฑุฏูุฏ.');
          }
        })
        .catch(error => {
          console.error('Error deleting all responses:', error);
          alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุฑุฏูุฏ.');
        });
    }

    // ูุชุญ ูุฑุจุน ุญูุงุฑ ุงูุชุญุฏูุซ
    function openUpdateModal(id) {
      currentResponseId = id;

      // ุงูุจุญุซ ุนู ุงูุฑุฏ ุงูุญุงูู
      const response = allResponses.find(r => r.id === id);

      if (response) {
        // ููุก ุงูุญููู ุจุงูููู ุงูุญุงููุฉ
        document.getElementById('update-id').value = response.id;

        // ูุง ูููุฃ ุญูู ุงูุฅุฌุงุจุฉ ุฅุฐุง ูุงูุช ููู ุตูุชู
        if (!isAudioFile(response.answer)) {
          document.getElementById('update-answer').value = response.answer;
        } else {
          document.getElementById('update-answer').value = '';
          document.getElementById('update-answer').placeholder = 'ุชุณุฌูู ุตูุชู (ูุง ูููู ุชุนุฏููู)';
        }

        // ุชูุณูู ุงูุชุงุฑูุฎ ูุญูู datetime-local
        const timestamp = new Date(response.timestamp);
        const formattedTimestamp = timestamp.toISOString().slice(0, 16);
        document.getElementById('update-timestamp').value = formattedTimestamp;
      }

      document.getElementById('updateModal').style.display = 'flex';
    }

    // ุฅุบูุงู ูุฑุจุน ุงูุญูุงุฑ
    function closeModal() {
      document.getElementById('updateModal').style.display = 'none';
    }

    // ุฅุฑุณุงู ุงูุชุญุฏูุซ
    function submitUpdate() {
      const newResponseId = document.getElementById('update-id').value;
      const newAnswer = document.getElementById('update-answer').value;
      const newTimestamp = document.getElementById('update-timestamp').value;

      // ุงูุชุญูู ูู ูุฌูุฏ ุจูุงูุงุช ููุชุญุฏูุซ
      if (!newAnswer && !newTimestamp && !newResponseId) {
        alert('ุงูุฑุฌุงุก ุฅุฏุฎุงู ุจูุงูุงุช ููุชุญุฏูุซ.');
        return;
      }

      // ุฅูุดุงุก ูุงุฆู ุงูุชุญุฏูุซ
      const updateData = {};

      if (newResponseId) {
        updateData.id = newResponseId;
      }

      if (newAnswer) {
        updateData.answer = newAnswer;
      }

      if (newTimestamp) {
        updateData.timestamp = newTimestamp;
      }

      // ุฅุฑุณุงู ุทูุจ ุงูุชุญุฏูุซ
      fetch('/api/responses/' + currentResponseId, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateData)
      })
        .then(res => {
          if (res.ok) {
            alert('ุชู ุชุญุฏูุซ ุงูุฑุฏ ุจูุฌุงุญ!');
            closeModal();
            loadResponses();
          } else {
            alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุฑุฏ.');
          }
        })
        .catch(error => {
          console.error('Error updating response:', error);
          alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุงูุฑุฏ.');
        });
    }

    function exportToCSV() {
      const csvContent = "data:text/csv;charset=utf-8,"
        + allResponses.map(response => `${response.id},${response.question},${response.answer},${response.timestamp}`).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "responses.csv");
      document.body.appendChild(link);
      link.click();
    }

    // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
    function updateStats() {
      const statsList = document.getElementById('stats-list');
      statsList.innerHTML = '';

      // ุญุณุงุจ ุนุฏุฏ ุงูุฑุฏูุฏ ููู ุณุคุงู
      const questionCounts = allResponses.reduce((acc, response) => {
        acc[response.question] = (acc[response.question] || 0) + 1;
        return acc;
      }, {});

      // ุญุณุงุจ ุชูุฒูุน ุงููุฒุงุฌ ููู ุณุคุงู
      const questionMoods = {};

      uniqueQuestions.forEach(question => {
        questionMoods[question] = {
          'ูุจุณูุทุฉ': 0,
          'ูุญุงูุฏุฉ': 0,
          'ูุชุถุงููุฉ': 0
        };
      });

      allResponses.forEach(response => {
        if (response.answer.includes('ูุจุณูุทู')) {
          questionMoods[response.question]['ูุจุณูุทุฉ']++;
        } else if (response.answer.includes('ูุนูู ุดููู')) {
          questionMoods[response.question]['ูุญุงูุฏุฉ']++;
        } else if (response.answer.includes('ูุชุถุงููุฉ') || response.answer.includes('ูุด ูุจุณูุทู')) {
          questionMoods[response.question]['ูุชุถุงููุฉ']++;
        }
      });

      // ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช
      for (const [question, count] of Object.entries(questionCounts)) {
        const li = document.createElement('li');

        // ุญุณุงุจ ุงููุณุจ ุงููุฆููุฉ
        const happy = questionMoods[question]['ูุจุณูุทุฉ'];
        const neutral = questionMoods[question]['ูุญุงูุฏุฉ'];
        const sad = questionMoods[question]['ูุชุถุงููุฉ'];

        const happyPercent = Math.round((happy / count) * 100) || 0;
        const neutralPercent = Math.round((neutral / count) * 100) || 0;
        const sadPercent = Math.round((sad / count) * 100) || 0;

        li.innerHTML = `
          <strong>${question}</strong>: ${count} ุฅุฌุงุจุฉ
          <div style="display: flex; height: 10px; width: 100%; margin-top: 5px; border-radius: 5px; overflow: hidden;">
            <div style="width: ${happyPercent}%; background-color: rgba(0, 184, 148, 0.8);"></div>
            <div style="width: ${neutralPercent}%; background-color: rgba(253, 203, 110, 0.8);"></div>
            <div style="width: ${sadPercent}%; background-color: rgba(231, 76, 60, 0.8);"></div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 0.8em; margin-top: 2px;">
            <span>ูุจุณูุทุฉ: ${happyPercent}%</span>
            <span>ูุญุงูุฏุฉ: ${neutralPercent}%</span>
            <span>ูุชุถุงููุฉ: ${sadPercent}%</span>
          </div>
        `;

        statsList.appendChild(li);
      }
    }

    // ุชุตุฏูุฑ ุงูุจูุงูุงุช ุฅูู CSV
    function exportToCSV() {
      // ุฅูุดุงุก ุฑุฃุณ ุงูููู
      const headers = ["ID", "ุงูุณุคุงู", "ุงูุฅุฌุงุจุฉ", "ุงูุชุงุฑูุฎ"];

      // ุชุญููู ุงูุจูุงูุงุช ุฅูู ุชูุณูู CSV
      const csvContent = "data:text/csv;charset=utf-8,"
        + headers.join(",") + "\n"
        + allResponses.map(response => {
            // ูุนุงูุฌุฉ ุงูุฅุฌุงุจุฉ ูุชุฌูุจ ูุดุงูู ุงูููุงุตู
            let answer = response.answer;
            if (isAudioFile(answer)) {
              answer = "ุชุณุฌูู ุตูุชู";
            } else {
              // ุงุณุชุจุฏุงู ุงูููุงุตู ุจูุณุงูุงุช ูุชุฌูุจ ูุดุงูู ุชูุณูู CSV
              answer = answer.replace(/,/g, " ");
            }

            return `${response.id},${response.question},${answer},${response.timestamp}`;
          }).join("\n");

      // ุฅูุดุงุก ุฑุงุจุท ุงูุชูุฒูู
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `ุฑุฏูุฏ_ุงููุฒุงุฌ_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ุญุฐู ุงูุฑุฏูุฏ ุงููุญุฏุฏุฉ
    function deleteSelectedResponses() {
      const selected = Array.from(document.querySelectorAll('.select-response:checked')).map(cb => cb.value);

      if (selected.length === 0) {
        alert('ูู ูุชู ุชุญุฏูุฏ ุฃู ุฑุฏูุฏ.');
        return;
      }

      if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ${selected.length} ุฑุฏ ูุญุฏุฏุ`)) return;

      Promise.all(selected.map(id => fetch('/api/responses/' + id, { method: 'DELETE' })))
        .then(() => {
          alert('ุชู ุญุฐู ุงูุฑุฏูุฏ ุงููุญุฏุฏุฉ ุจูุฌุงุญ!');
          loadResponses();
        })
        .catch(error => {
          console.error('Error deleting responses:', error);
          alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงูุฑุฏูุฏ.');
        });
    }

    // ุชุญุฏูุฏ/ุฅูุบุงุก ุชุญุฏูุฏ ุฌููุน ุงูุฑุฏูุฏ
    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('.select-response');
      const selectAll = document.getElementById('select-all').checked;
      checkboxes.forEach(cb => cb.checked = selectAll);
    }



    // ุชูุณูู ุงูููุช
    function formatTime(timeStr) {
      if (!timeStr) return '';

      // ุฅุฐุง ูุงู ุงูููุช ุจุชูุณูู "HH:MM:SS"ุ ูููู ุจุชุญูููู ุฅูู "HH:MM"
      if (timeStr.length > 5) {
        return timeStr.substring(0, 5);
      }

      return timeStr;
    }

    // ูุญุต ูููุงุช ุงูุตูุช
    function checkAudioFiles() {
      const statusContainer = document.getElementById('audio-status');
      statusContainer.innerHTML = '<p>ุฌุงุฑู ูุญุต ูููุงุช ุงูุตูุช...</p>';

      fetch('/api/check-audio-files')
        .then(res => res.json())
        .then(data => {
          const { totalAudioResponses, fileStatus } = data;

          // ุญุณุงุจ ุงูุฅุญุตุงุฆูุงุช
          const missingFiles = fileStatus.filter(file => !file.exists);
          const hasBackup = fileStatus.filter(file => file.backup_exists);

          // ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช
          let statusHTML = `
            <div class="backup-stats">
              <div class="backup-stat">
                <h4>ุฅุฌูุงูู ุงูุชุณุฌููุงุช</h4>
                <div class="value">${totalAudioResponses}</div>
              </div>
              <div class="backup-stat">
                <h4>ุงููููุงุช ุงูููููุฏุฉ</h4>
                <div class="value">${missingFiles.length}</div>
              </div>
              <div class="backup-stat">
                <h4>ููุง ูุณุฎุฉ ุงุญุชูุงุทูุฉ</h4>
                <div class="value">${hasBackup.length}</div>
              </div>
            </div>
          `;

          // ุฅุถุงูุฉ ุฑุณุงูุฉ ุงูุญุงูุฉ
          if (missingFiles.length === 0) {
            statusHTML += `
              <div class="status-container status-success">
                <p>ุฌููุน ูููุงุช ุงูุตูุช ููุฌูุฏุฉ ูุณูููุฉ.</p>
              </div>
            `;
            document.getElementById('missing-files-container').style.display = 'none';
          } else {
            statusHTML += `
              <div class="status-container status-warning">
                <p>ููุงู ${missingFiles.length} ููู ุตูุชู ููููุฏ. ููููู ุงุณุชุนุงุฏุชูุง ูู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ ุฅุฐุง ูุงูุช ูุชููุฑุฉ.</p>
              </div>
            `;

            // ุนุฑุถ ุงููููุงุช ุงูููููุฏุฉ
            document.getElementById('missing-files-container').style.display = 'block';
            const missingFilesTable = document.getElementById('missing-files');
            missingFilesTable.innerHTML = '';

            missingFiles.forEach(file => {
              const row = document.createElement('tr');
              const formattedDate = new Date(file.timestamp).toLocaleString('ar-EG');

              row.innerHTML = `
                <td>${file.id}</td>
                <td>${file.path}</td>
                <td>${formattedDate}</td>
                <td>${file.backup_exists ? 'ูุชููุฑุฉ' : 'ุบูุฑ ูุชููุฑุฉ'}</td>
                <td>
                  ${file.backup_exists ?
                    `<button class="restore-btn" onclick="restoreAudioFile(${file.id})">ุงุณุชุนุงุฏุฉ</button>` :
                    'ูุง ูููู ุงูุงุณุชุนุงุฏุฉ'}
                </td>
              `;

              missingFilesTable.appendChild(row);
            });
          }

          statusContainer.innerHTML = statusHTML;
        })
        .catch(error => {
          console.error('Error checking audio files:', error);
          statusContainer.innerHTML = `
            <div class="status-container status-error">
              <p>ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุญุต ูููุงุช ุงูุตูุช. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.</p>
            </div>
          `;
        });
    }

    // ุชุญููู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ
    function loadBackups() {
      fetch('/api/backups')
        .then(res => res.json())
        .then(data => {
          const { total, backups } = data;

          const backupsList = document.getElementById('backups-list');
          backupsList.innerHTML = '';

          if (backups.length === 0) {
            backupsList.innerHTML = '<tr><td colspan="4" style="text-align: center;">ูุง ุชูุฌุฏ ูุณุฎ ุงุญุชูุงุทูุฉ ูุชููุฑุฉ</td></tr>';
            return;
          }

          backups.forEach(backup => {
            const row = document.createElement('tr');
            const formattedDate = new Date(backup.created).toLocaleString('ar-EG');
            const formattedSize = formatFileSize(backup.size);

            row.innerHTML = `
              <td>${backup.filename}</td>
              <td>${formattedSize}</td>
              <td>${formattedDate}</td>
              <td>
                <a href="${backup.path}" download class="download-btn">ุชุญููู</a>
              </td>
            `;

            backupsList.appendChild(row);
          });
        })
        .catch(error => {
          console.error('Error loading backups:', error);
          document.getElementById('backups-list').innerHTML =
            '<tr><td colspan="4" style="text-align: center;">ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงููุณุฎ ุงูุงุญุชูุงุทูุฉ</td></tr>';
        });
    }

    // ุงุณุชุนุงุฏุฉ ููู ุตูุชู ูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ
    function restoreAudioFile(id) {
      if (!confirm('ูู ุฃูุช ูุชุฃูุฏ ูู ุงุณุชุนุงุฏุฉ ูุฐุง ุงูููู ูู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉุ')) return;

      fetch('/api/restore-audio/' + id, {
        method: 'POST'
      })
        .then(res => res.json())
        .then(data => {
          if (data.message) {
            alert('ุชู ุงุณุชุนุงุฏุฉ ุงูููู ุจูุฌุงุญ!');
            checkAudioFiles(); // ุฅุนุงุฏุฉ ูุญุต ุงููููุงุช
          } else {
            alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุนุงุฏุฉ ุงูููู: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error restoring audio file:', error);
          alert('ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุนุงุฏุฉ ุงูููู');
        });
    }

    // ุชูุณูู ุญุฌู ุงูููู
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';

      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));

      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  </script>
</body>
</html>