<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ù…Ø²Ø§Ø¬ Ø­Ø¨ÙŠØ¨ØªÙŠ</title>
  <link rel="stylesheet" href="/admin-styles.css">
  <!-- Ø¥Ø¶Ø§ÙØ© Chart.js Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="container">
    <h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ù…Ø²Ø§Ø¬ Ø­Ø¨ÙŠØ¨ØªÙŠ</h1>

    <!-- Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
    <ul class="nav-tabs">
      <li class="active" onclick="showTab('dashboard')">Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</li>
      <li onclick="showTab('responses')">Ø§Ù„Ø±Ø¯ÙˆØ¯</li>
      <li onclick="showTab('analytics')">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª</li>

      <li onclick="showTab('backups')">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</li>
    </ul>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
    <div id="dashboard-tab" class="tab-content active">
      <div class="dashboard">
        <div class="card">
          <div class="card-header">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯</div>
          <div class="card-body" id="total-responses">0</div>
          <div class="card-footer">ÙƒÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</div>
        </div>

        <div class="card">
          <div class="card-header">Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…</div>
          <div class="card-body" id="today-responses">0</div>
          <div class="card-footer">Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ…</div>
        </div>

        <div class="card">
          <div class="card-header">Ø§Ù„Ù…Ø²Ø§Ø¬ Ø§Ù„Ø¹Ø§Ù…</div>
          <div class="card-body" id="mood-indicator">ğŸ˜Š</div>
          <div class="card-footer">Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ø§Ù„Ø±Ø¯ÙˆØ¯</div>
        </div>
      </div>

      <div class="chart-container">
        <canvas id="mood-chart"></canvas>
      </div>

      <div class="chart-container">
        <canvas id="responses-chart"></canvas>
      </div>
    </div>

    <!-- Ø§Ù„Ø±Ø¯ÙˆØ¯ -->
    <div id="responses-tab" class="tab-content">
      <div class="controls">
        <div class="search-filters">
          <input type="text" id="search" placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø³Ø¤Ø§Ù„ Ø£Ùˆ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©..." oninput="filterResponses()">
          <select id="filter-question" onchange="filterResponses()">
            <option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</option>
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ -->
          </select>
          <select id="filter-mood" onchange="filterResponses()">
            <option value="">ÙƒÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ù…Ø²Ø§Ø¬ÙŠØ©</option>
            <option value="Ù…Ø¨Ø³ÙˆØ·Ù‡">Ù…Ø¨Ø³ÙˆØ·Ø©</option>
            <option value="Ù…ØªØ¶Ø§ÙŠÙ‚Ø©">Ù…ØªØ¶Ø§ÙŠÙ‚Ø©</option>
            <option value="ÙŠØ¹Ù†ÙŠ">Ù…Ø­Ø§ÙŠØ¯Ø©</option>
          </select>
          <input type="date" id="filter-date" onchange="filterResponses()">
        </div>

        <div class="action-buttons">
          <button onclick="clearFilters()" class="secondary-btn">Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±</button>
          <button onclick="exportToCSV()" class="secondary-btn">ØªØµØ¯ÙŠØ± CSV</button>
          <button onclick="deleteSelectedResponses()" class="danger-btn">Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
          <button onclick="reorderAllIds()" class="primary-btn">Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ù€ IDs</button>
        </div>
      </div>

      <div class="mobile-table-container">
        <table>
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all" onclick="toggleSelectAll()"></th>
              <th>ID</th>
              <th>Ø§Ù„Ø³Ø¤Ø§Ù„</th>
              <th>Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>

          <tbody id="responses">
            <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù‡Ù†Ø§ -->
          </tbody>
        </table>
      </div>

      <div class="pagination">
        <button id="prev-page" onclick="changePage(-1)" disabled>Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <span id="page-info">ØµÙØ­Ø© <span id="current-page">1</span> Ù…Ù† <span id="total-pages">1</span></span>
        <button id="next-page" onclick="changePage(1)" disabled>Ø§Ù„ØªØ§Ù„ÙŠ</button>
        <select id="page-size" onchange="changePageSize()">
          <option value="10">10 Ø±Ø¯ÙˆØ¯</option>
          <option value="25">25 Ø±Ø¯</option>
          <option value="50">50 Ø±Ø¯</option>
          <option value="100">100 Ø±Ø¯</option>
        </select>
      </div>
    </div>

    <!-- Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª -->
    <div id="analytics-tab" class="tab-content">
      <h2>ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ù…Ø²Ø§Ø¬</h2>

      <div class="chart-container">
        <canvas id="mood-distribution-chart"></canvas>
      </div>

      <div class="chart-container">
        <canvas id="mood-trend-chart"></canvas>
      </div>

      <div class="stats">
        <h3>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</h3>
        <ul id="stats-list"></ul>
      </div>

      <div class="stats">
        <h3>Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø£ÙƒØ«Ø± ØªÙƒØ±Ø§Ø±Ù‹Ø§</h3>
        <ul id="common-words"></ul>
      </div>
    </div>



    <!-- Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© -->
    <div id="backups-tab" class="tab-content">
      <h2>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù„Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©</h2>

      <div class="controls">
        <div class="action-buttons">
          <button onclick="checkAudioFiles()" class="primary-btn">ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª</button>
          <button onclick="loadBackups()" class="secondary-btn">ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
        </div>
      </div>

      <div class="backup-section">
        <h3>Ø­Ø§Ù„Ø© Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª</h3>
        <div id="audio-status" class="status-container">
          <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª" Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ù„ÙØ§Øª.</p>
        </div>

        <div id="missing-files-container" style="display: none;">
          <h3>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©</h3>
          <div class="mobile-table-container">
            <table id="missing-files-table">
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Ø§Ù„Ù…Ø³Ø§Ø±</th>
                  <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                  <th>Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</th>
                  <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                </tr>
              </thead>
              <tbody id="missing-files">
                <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div class="backup-section">
        <h3>Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©</h3>
        <div class="mobile-table-container">
          <table>
            <thead>
              <tr>
                <th>Ø§Ø³Ù… Ø§Ù„Ù…Ù„Ù</th>
                <th>Ø§Ù„Ø­Ø¬Ù…</th>
                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="backups-list">
              <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠÙ‹Ø§ -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for updating response -->
<!-- Ù…Ø±Ø¨Ø¹ Ø­ÙˆØ§Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¯ -->
<div class="modal" id="updateModal">
  <div class="modal-content">
    <h2>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¯</h2>
    <input type="text" id="update-id" placeholder="Ø±Ù‚Ù… Ø§Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯">
    <input type="text" id="update-answer" placeholder="Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
    <input type="datetime-local" id="update-timestamp">
    <div class="modal-buttons">
      <button onclick="submitUpdate()">ØªØ­Ø¯ÙŠØ«</button>
      <button onclick="closeModal()" class="cancel">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>



  <script>
    let allResponses = [];
    let currentResponseId = null;
    let charts = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø±Ø§Ø¬Ø¹ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    let uniqueQuestions = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙØ±ÙŠØ¯Ø©


    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = function() {
      loadResponses();

      loadBackups();

      // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„ÙÙ„ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ÙŠÙƒÙˆÙ† Ø§Ù„ÙŠÙˆÙ…
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('filter-date').value = '';

      // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„ØªØ¨ÙˆÙŠØ¨
      document.querySelectorAll('.nav-tabs li').forEach(tab => {
        tab.addEventListener('click', function() {
          const tabName = this.getAttribute('onclick').match(/'([^']+)'/)[1];
          if (tabName === 'backups') {
            loadBackups();
          }
        });
      });
    };

    // Ø¹Ø±Ø¶ Ø¹Ù„Ø§Ù…Ø© ØªØ¨ÙˆÙŠØ¨ Ù…Ø­Ø¯Ø¯Ø©
    function showTab(tabName) {
      // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªØ¨ÙˆÙŠØ¨
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });

      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
      document.querySelectorAll('.nav-tabs li').forEach(item => {
        item.classList.remove('active');
      });

      // Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
      document.getElementById(tabName + '-tab').classList.add('active');

      // ØªØ­Ø¯ÙŠØ¯ Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
      document.querySelector(`.nav-tabs li[onclick="showTab('${tabName}')"]`).classList.add('active');

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø¹Ù„Ø§Ù…Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ù‡ÙŠ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø£Ùˆ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª
      if (tabName === 'dashboard' || tabName === 'analytics') {
        updateCharts();
      }
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
    function loadResponses() {
      fetch('/api/responses')
        .then(res => res.json())
        .then(data => {
          allResponses = data;

          // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„ÙØ±ÙŠØ¯Ø©
          uniqueQuestions = [...new Set(data.map(response => response.question))];

          // Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙÙŠ Ø§Ù„ÙÙ„ØªØ±
          const filterQuestion = document.getElementById('filter-question');
          filterQuestion.innerHTML = '<option value="">ÙƒÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©</option>';
          uniqueQuestions.forEach(question => {
            const option = document.createElement('option');
            option.value = question;
            option.textContent = question;
            filterQuestion.appendChild(option);
          });

          renderResponses(data);
          updateStats();
          updateDashboard();
          updateCharts();
        })
        .catch(error => {
          console.error('Error loading responses:', error);
        });
    }

    // ØªØ­Ø¯ÙŠØ« Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
    function updateDashboard() {
      if (!allResponses || allResponses.length === 0) return;

      // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±Ø¯ÙˆØ¯
      document.getElementById('total-responses').textContent = allResponses.length;

      // Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙŠÙˆÙ…
      const today = new Date().toISOString().split('T')[0];
      const todayResponses = allResponses.filter(response =>
        response.timestamp.startsWith(today)
      ).length;
      document.getElementById('today-responses').textContent = todayResponses;

      // Ø§Ù„Ù…Ø²Ø§Ø¬ Ø§Ù„Ø¹Ø§Ù…
      const moodIndicator = getMoodIndicator();
      document.getElementById('mood-indicator').textContent = moodIndicator;
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    function updateCharts() {
      // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
      Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
      });

      // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ù…Ø²Ø§Ø¬
      createMoodChart();

      // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø±Ø¯ÙˆØ¯
      createResponsesChart();

      // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø²Ø§Ø¬
      createMoodDistributionChart();

      // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø²Ø§Ø¬
      createMoodTrendChart();

      // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
      updateCommonWords();
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ù…Ø²Ø§Ø¬
    function createMoodChart() {
      const ctx = document.getElementById('mood-chart').getContext('2d');

      // ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø²Ø§Ø¬
      const moodData = analyzeMoodData();

      charts.mood = new Chart(ctx, {
        type: 'line',
        data: {
          labels: moodData.labels,
          datasets: [{
            label: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø²Ø§Ø¬',
            data: moodData.data,
            backgroundColor: 'rgba(108, 92, 231, 0.2)',
            borderColor: 'rgba(108, 92, 231, 1)',
            borderWidth: 2,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'ØªØºÙŠØ± Ø§Ù„Ù…Ø²Ø§Ø¬ Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ù…Ø§Ø¶ÙŠ',
              font: {
                size: 16
              }
            },
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 10,
              title: {
                display: true,
                text: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø²Ø§Ø¬ (1-10)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Ø§Ù„ØªØ§Ø±ÙŠØ®'
              }
            }
          }
        }
      });
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø±Ø¯ÙˆØ¯
    function createResponsesChart() {
      const ctx = document.getElementById('responses-chart').getContext('2d');

      // ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¯ÙˆØ¯
      const responseData = analyzeResponseData();

      charts.responses = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: responseData.labels,
          datasets: [{
            label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯',
            data: responseData.data,
            backgroundColor: 'rgba(253, 121, 168, 0.6)',
            borderColor: 'rgba(253, 121, 168, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…',
              font: {
                size: 16
              }
            },
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Ø§Ù„ÙŠÙˆÙ…'
              }
            }
          }
        }
      });
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø²Ø§Ø¬
    function createMoodDistributionChart() {
      const ctx = document.getElementById('mood-distribution-chart').getContext('2d');

      // ØªØ­Ù„ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø²Ø§Ø¬
      const moodDistribution = analyzeMoodDistribution();

      charts.moodDistribution = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: moodDistribution.labels,
          datasets: [{
            data: moodDistribution.data,
            backgroundColor: [
              'rgba(0, 184, 148, 0.6)',
              'rgba(253, 203, 110, 0.6)',
              'rgba(231, 76, 60, 0.6)',
              'rgba(108, 92, 231, 0.6)'
            ],
            borderColor: [
              'rgba(0, 184, 148, 1)',
              'rgba(253, 203, 110, 1)',
              'rgba(231, 76, 60, 1)',
              'rgba(108, 92, 231, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø²Ø§Ø¬',
              font: {
                size: 16
              }
            },
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }

    // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø²Ø§Ø¬
    function createMoodTrendChart() {
      const ctx = document.getElementById('mood-trend-chart').getContext('2d');

      // ØªØ­Ù„ÙŠÙ„ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø²Ø§Ø¬
      const moodTrend = analyzeMoodTrend();

      charts.moodTrend = new Chart(ctx, {
        type: 'line',
        data: {
          labels: moodTrend.labels,
          datasets: moodTrend.datasets
        },
        options: {
          responsive: true,
          plugins: {
            title: {
              display: true,
              text: 'Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø²Ø§Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¤Ø§Ù„',
              font: {
                size: 16
              }
            },
            legend: {
              position: 'bottom'
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 10,
              title: {
                display: true,
                text: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø²Ø§Ø¬ (1-10)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Ø§Ù„ØªØ§Ø±ÙŠØ®'
              }
            }
          }
        }
      });
    }

    // ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø²Ø§Ø¬
    function analyzeMoodData() {
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø¨Ø¹Ø© Ø§Ù„Ù…Ø§Ø¶ÙŠØ©
      const dates = [];
      const data = [];

      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateString = date.toISOString().split('T')[0];
        dates.push(dateString);

        // Ø­Ø³Ø§Ø¨ Ù…ØªÙˆØ³Ø· Ø§Ù„Ù…Ø²Ø§Ø¬ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
        const dayResponses = allResponses.filter(response =>
          response.timestamp.startsWith(dateString)
        );

        if (dayResponses.length > 0) {
          const moodScore = calculateMoodScore(dayResponses);
          data.push(moodScore);
        } else {
          data.push(null); // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
        }
      }

      return {
        labels: dates.map(date => formatDate(date)),
        data: data
      };
    }

    // ØªØ­Ù„ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø¯ÙˆØ¯
    function analyzeResponseData() {
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø¨Ø¹Ø© Ø§Ù„Ù…Ø§Ø¶ÙŠØ©
      const dates = [];
      const data = [];

      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateString = date.toISOString().split('T')[0];
        dates.push(dateString);

        // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
        const dayResponses = allResponses.filter(response =>
          response.timestamp.startsWith(dateString)
        ).length;

        data.push(dayResponses);
      }

      return {
        labels: dates.map(date => formatDate(date)),
        data: data
      };
    }

    // ØªØ­Ù„ÙŠÙ„ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø²Ø§Ø¬
    function analyzeMoodDistribution() {
      const moodCounts = {
        'Ù…Ø¨Ø³ÙˆØ·Ø©': 0,
        'Ù…Ø­Ø§ÙŠØ¯Ø©': 0,
        'Ù…ØªØ¶Ø§ÙŠÙ‚Ø©': 0,
        'Ø£Ø®Ø±Ù‰': 0
      };

      allResponses.forEach(response => {
        if (response.answer.includes('Ù…Ø¨Ø³ÙˆØ·Ù‡')) {
          moodCounts['Ù…Ø¨Ø³ÙˆØ·Ø©']++;
        } else if (response.answer.includes('ÙŠØ¹Ù†ÙŠ Ø´ÙˆÙŠÙ‡')) {
          moodCounts['Ù…Ø­Ø§ÙŠØ¯Ø©']++;
        } else if (response.answer.includes('Ù…ØªØ¶Ø§ÙŠÙ‚Ø©') || response.answer.includes('Ù…Ø´ Ù…Ø¨Ø³ÙˆØ·Ù‡')) {
          moodCounts['Ù…ØªØ¶Ø§ÙŠÙ‚Ø©']++;
        } else {
          moodCounts['Ø£Ø®Ø±Ù‰']++;
        }
      });

      return {
        labels: Object.keys(moodCounts),
        data: Object.values(moodCounts)
      };
    }

    // ØªØ­Ù„ÙŠÙ„ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù…Ø²Ø§Ø¬
    function analyzeMoodTrend() {
      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø³Ø¨Ø¹Ø© Ø§Ù„Ù…Ø§Ø¶ÙŠØ©
      const dates = [];

      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateString = date.toISOString().split('T')[0];
        dates.push(dateString);
      }

      // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„
      const datasets = [];
      const colors = [
        'rgba(108, 92, 231, 1)',
        'rgba(253, 121, 168, 1)',
        'rgba(0, 184, 148, 1)',
        'rgba(253, 203, 110, 1)'
      ];

      uniqueQuestions.forEach((question, index) => {
        const data = [];

        dates.forEach(date => {
          // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¤Ø§Ù„ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
          const dayResponses = allResponses.filter(response =>
            response.timestamp.startsWith(date) && response.question === question
          );

          if (dayResponses.length > 0) {
            const moodScore = calculateMoodScore(dayResponses);
            data.push(moodScore);
          } else {
            data.push(null); // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…
          }
        });

        datasets.push({
          label: question,
          data: data,
          borderColor: colors[index % colors.length],
          backgroundColor: colors[index % colors.length].replace('1)', '0.2)'),
          borderWidth: 2,
          tension: 0.3
        });
      });

      return {
        labels: dates.map(date => formatDate(date)),
        datasets: datasets
      };
    }

    // Ø­Ø³Ø§Ø¨ Ø¯Ø±Ø¬Ø© Ø§Ù„Ù…Ø²Ø§Ø¬
    function calculateMoodScore(responses) {
      let totalScore = 0;
      let count = 0;

      responses.forEach(response => {
        let score = 5; // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ø­Ø§ÙŠØ¯Ø©

        if (response.answer.includes('Ù…Ø¨Ø³ÙˆØ·Ù‡')) {
          score = 8;
        } else if (response.answer.includes('ÙŠØ¹Ù†ÙŠ Ø´ÙˆÙŠÙ‡')) {
          score = 5;
        } else if (response.answer.includes('Ù…ØªØ¶Ø§ÙŠÙ‚Ø©') || response.answer.includes('Ù…Ø´ Ù…Ø¨Ø³ÙˆØ·Ù‡')) {
          score = 2;
        }

        totalScore += score;
        count++;
      });

      return count > 0 ? totalScore / count : 5;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø²Ø§Ø¬
    function getMoodIndicator() {
      if (!allResponses || allResponses.length === 0) return 'ğŸ˜';

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± 5 Ø±Ø¯ÙˆØ¯
      const recentResponses = allResponses.slice(0, 5);
      const moodScore = calculateMoodScore(recentResponses);

      if (moodScore >= 7) {
        return 'ğŸ˜Š';
      } else if (moodScore >= 4) {
        return 'ğŸ˜';
      } else {
        return 'ğŸ˜”';
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
    function updateCommonWords() {
      // Ø¬Ù…Ø¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ù†ØµÙŠØ©
      const textAnswers = allResponses
        .filter(response => !isAudioFile(response.answer))
        .map(response => response.answer);

      // ØªØ­Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
      const wordCounts = {};
      const stopWords = ['ÙÙŠ', 'Ù…Ù†', 'Ø¹Ù„Ù‰', 'Ø¥Ù„Ù‰', 'Ø¹Ù†', 'Ù…Ø¹', 'Ù‡Ø°Ø§', 'Ù‡Ø°Ù‡', 'Ø°Ù„Ùƒ', 'ØªÙ„Ùƒ', 'Ù‡Ùˆ', 'Ù‡ÙŠ', 'Ø£Ù†Ø§', 'Ø£Ù†Øª', 'Ù†Ø­Ù†', 'Ù‡Ù…'];

      textAnswers.forEach(answer => {
        const words = answer.split(/\s+/);
        words.forEach(word => {
          word = word.replace(/[^\p{L}\p{N}]/gu, '').trim().toLowerCase();
          if (word && word.length > 1 && !stopWords.includes(word)) {
            wordCounts[word] = (wordCounts[word] || 0) + 1;
          }
        });
      });

      // ØªØ±ØªÙŠØ¨ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªÙƒØ±Ø§Ø±
      const sortedWords = Object.entries(wordCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      // Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø´Ø§Ø¦Ø¹Ø©
      const commonWordsList = document.getElementById('common-words');
      commonWordsList.innerHTML = '';

      sortedWords.forEach(([word, count]) => {
        const li = document.createElement('li');
        li.textContent = `${word}: ${count} Ù…Ø±Ø©`;
        commonWordsList.appendChild(li);
      });
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('ar-EG', { weekday: 'short', month: 'short', day: 'numeric' });
    }

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù‡ÙŠ Ù…Ù„Ù ØµÙˆØªÙŠ
    function isAudioFile(answer) {
      if (!answer) return false;
      return answer.startsWith('/uploads/') || /\.(mp3|wav|ogg|webm|audio)$/i.test(answer);
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ÙˆØ¹ MIME Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª
    function getAudioMimeType(filePath) {
      if (!filePath) return 'audio/mpeg';
      if (filePath.endsWith('.mp3')) return 'audio/mpeg';
      if (filePath.endsWith('.wav')) return 'audio/wav';
      if (filePath.endsWith('.ogg')) return 'audio/ogg';
      if (filePath.endsWith('.webm')) return 'audio/webm';
      return 'audio/mpeg'; // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
    }

    // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ…
    let currentPage = 1;
    let pageSize = 10;
    let filteredResponses = [];

    // Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¯ÙˆØ¯
    function renderResponses(data) {
      filteredResponses = [...data]; // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµÙØ§Ø© Ù„Ù„ØªØ±Ù‚ÙŠÙ…

      // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ù‚ÙŠÙ…
      const startIndex = (currentPage - 1) * pageSize;
      const endIndex = startIndex + pageSize;
      const paginatedData = data.slice(startIndex, endIndex);

      // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ…
      updatePagination(data.length);

      const tbody = document.getElementById('responses');
      tbody.innerHTML = '';

      if (data.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="6" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø¯ÙˆØ¯ Ù…ØªØ§Ø­Ø©</td>`;
        tbody.appendChild(row);
        return;
      }

      paginatedData.forEach(response => {
        const row = document.createElement('tr');
        const formattedDate = new Date(response.timestamp).toLocaleString('ar-EG');

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ù„Ù ØµÙˆØªÙŠ
        const isAudio = isAudioFile(response.answer);
        const audioMimeType = isAudio ? getAudioMimeType(response.answer) : '';

        // ØªØ­Ø¯ÙŠØ¯ Ù„ÙˆÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø²Ø§Ø¬
        let rowClass = '';
        if (response.answer.includes('Ù…Ø¨Ø³ÙˆØ·Ù‡')) {
          rowClass = 'background-color: rgba(0, 184, 148, 0.1);';
        } else if (response.answer.includes('Ù…ØªØ¶Ø§ÙŠÙ‚Ø©') || response.answer.includes('Ù…Ø´ Ù…Ø¨Ø³ÙˆØ·Ù‡')) {
          rowClass = 'background-color: rgba(231, 76, 60, 0.1);';
        } else if (response.answer.includes('ÙŠØ¹Ù†ÙŠ Ø´ÙˆÙŠÙ‡')) {
          rowClass = 'background-color: rgba(253, 203, 110, 0.1);';
        }

        row.style = rowClass;
        row.innerHTML = `
          <td><input type="checkbox" class="select-response" value="${response.id}"></td>
          <td>${response.id}</td>
          <td>${response.question}</td>
          <td>
            ${isAudio ?
              `<div class="audio-player" data-src="${response.answer}" data-type="${audioMimeType}">
                <div class="custom-audio-player">
                  <div class="audio-progress-container">
                    <div class="audio-progress-bar"></div>
                  </div>
                  <div class="audio-controls">
                    <div class="audio-buttons">
                      <button class="play-btn" title="ØªØ´ØºÙŠÙ„">â–¶ï¸</button>
                      <button class="pause-btn" title="Ø¥ÙŠÙ‚Ø§Ù Ù…Ø¤Ù‚Øª" style="display:none;">â¸ï¸</button>
                      <button class="stop-btn" title="Ø¥ÙŠÙ‚Ø§Ù">â¹ï¸</button>
                    </div>
                    <div class="audio-time">
                      <span class="current-time">00:00</span> / <span class="total-time">00:00</span>
                    </div>
                    <div class="audio-volume">
                      <span>ğŸ”Š</span>
                      <input type="range" min="0" max="1" step="0.1" value="1" class="volume-control">
                    </div>
                  </div>
                </div>
                <div class="audio-player-controls">
                  <a href="${response.answer}" download="${response.id}_audio${getFileExtension(response.answer)}" title="ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ" class="download-btn">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„</a>
                </div>
              </div>`
              : response.answer}
          </td>
          <td>${formattedDate}</td>
          <td>
            <button class="delete-btn" onclick="deleteResponse(${response.id})">Ø­Ø°Ù</button>
            <button class="edit-btn" onclick="openUpdateModal(${response.id})">ØªØ¹Ø¯ÙŠÙ„</button>
          </td>
        `;
        tbody.appendChild(row);
      });

      // ØªØ­Ø³ÙŠÙ† Ù…Ø´ØºÙ„ Ø§Ù„ØµÙˆØª
      enhanceAudioPlayers();
    }

    // ØªØ­Ø³ÙŠÙ† Ù…Ø´ØºÙ„Ø§Øª Ø§Ù„ØµÙˆØª
    function enhanceAudioPlayers() {
      // ØªÙ‡ÙŠØ¦Ø© Ø¬Ù…ÙŠØ¹ Ù…Ø´ØºÙ„Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ù…Ø®ØµØµØ©
      document.querySelectorAll('.audio-player').forEach(playerContainer => {
        const audioSrc = playerContainer.getAttribute('data-src');
        const audioType = playerContainer.getAttribute('data-type');

        if (!audioSrc) return;

        // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± Ø§Ù„ØµÙˆØª
        const audio = new Audio();
        audio.src = audioSrc;
        audio.preload = 'metadata';

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Ø§Ù„ØªØ­ÙƒÙ…
        const playBtn = playerContainer.querySelector('.play-btn');
        const pauseBtn = playerContainer.querySelector('.pause-btn');
        const stopBtn = playerContainer.querySelector('.stop-btn');
        const progressBar = playerContainer.querySelector('.audio-progress-bar');
        const progressContainer = playerContainer.querySelector('.audio-progress-container');
        const currentTimeDisplay = playerContainer.querySelector('.current-time');
        const totalTimeDisplay = playerContainer.querySelector('.total-time');
        const volumeControl = playerContainer.querySelector('.volume-control');

        // ØªØ¹ÙŠÙŠÙ† Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª Ø§Ù„Ø£Ù‚ØµÙ‰
        audio.volume = 1.0;

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙˆØµÙÙŠØ© Ù„Ù„ØµÙˆØª
        audio.addEventListener('loadedmetadata', () => {
          totalTimeDisplay.textContent = formatTime(audio.duration);
        });

        // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ
        audio.addEventListener('timeupdate', () => {
          const progress = (audio.currentTime / audio.duration) * 100;
          progressBar.style.width = `${progress}%`;
          currentTimeDisplay.textContent = formatTime(audio.currentTime);
        });

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª
        playBtn.addEventListener('click', () => {
          // Ø¥ÙŠÙ‚Ø§Ù Ø¬Ù…ÙŠØ¹ Ù…Ø´ØºÙ„Ø§Øª Ø§Ù„ØµÙˆØª Ø§Ù„Ø£Ø®Ø±Ù‰
          document.querySelectorAll('.audio-player').forEach(otherPlayer => {
            if (otherPlayer !== playerContainer) {
              const otherPlayBtn = otherPlayer.querySelector('.play-btn');
              const otherPauseBtn = otherPlayer.querySelector('.pause-btn');
              if (otherPlayBtn && otherPauseBtn) {
                otherPlayBtn.style.display = 'block';
                otherPauseBtn.style.display = 'none';
              }
            }
          });

          // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙˆØª Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ«Ù‡
          audio.load();

          // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø§Ù„Ø¬ Ø£Ø­Ø¯Ø§Ø« Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£
          audio.onerror = function(e) {
            console.error('Audio error:', e);
            console.error('Audio error code:', audio.error ? audio.error.code : 'unknown');
            console.error('Audio src:', audio.src);

            // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø³Ø§Ø±
            if (audio.src.startsWith(window.location.origin)) {
              // Ø§Ù„Ù…Ø³Ø§Ø± Ù…Ø·Ù„Ù‚ØŒ Ù„Ø§ Ø¯Ø§Ø¹ÙŠ Ù„Ù„ØªØºÙŠÙŠØ±
            } else {
              // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù†Ø³Ø¨ÙŠ Ø¥Ù„Ù‰ Ù…Ø·Ù„Ù‚
              const fixedSrc = window.location.origin + audioSrc;
              console.log('Trying fixed path:', fixedSrc);
              audio.src = fixedSrc;
              audio.load();
            }
          };

          // ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠ
          const playPromise = audio.play();

          if (playPromise !== undefined) {
            playPromise.catch(error => {
              console.error('Error playing audio:', error);

              // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„
              if (!audio.src.startsWith(window.location.origin)) {
                const fixedSrc = window.location.origin + audioSrc;
                console.log('Trying fixed path on error:', fixedSrc);
                audio.src = fixedSrc;
                audio.load();
                audio.play().catch(e => {
                  console.error('Still failed after path fix:', e);
                  alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                });
              } else {
                alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§ØªØµØ§Ù„ Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª ÙˆØ§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
              }
            });
          }

          // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
          playBtn.style.display = 'none';
          pauseBtn.style.display = 'block';
        });

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª Ù…Ø¤Ù‚ØªÙ‹Ø§
        pauseBtn.addEventListener('click', () => {
          audio.pause();

          // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
          playBtn.style.display = 'block';
          pauseBtn.style.display = 'none';
        });

        // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØµÙˆØª
        stopBtn.addEventListener('click', () => {
          audio.pause();
          audio.currentTime = 0;

          // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
          playBtn.style.display = 'block';
          pauseBtn.style.display = 'none';
        });

        // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØµÙˆØª
        volumeControl.addEventListener('input', () => {
          audio.volume = volumeControl.value;
        });

        // Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªÙ‚Ø¯Ù… Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        progressContainer.addEventListener('click', (event) => {
          const rect = progressContainer.getBoundingClientRect();
          const clickPosition = (event.clientX - rect.left) / rect.width;
          audio.currentTime = clickPosition * audio.duration;
        });

        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø¹Ù†Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙˆØª
        audio.addEventListener('ended', () => {
          audio.currentTime = 0;
          playBtn.style.display = 'block';
          pauseBtn.style.display = 'none';
        });
      });
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª (Ø«ÙˆØ§Ù†ÙŠ Ø¥Ù„Ù‰ mm:ss)
    function formatTime(seconds) {
      if (isNaN(seconds)) return '00:00';

      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = Math.floor(seconds % 60);

      return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
    }

    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù…ØªØ¯Ø§Ø¯ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù…Ø³Ø§Ø±
    function getFileExtension(filePath) {
      if (!filePath) return '.mp3';

      const extensions = ['.mp3', '.wav', '.ogg', '.webm', '.audio'];

      for (const ext of extensions) {
        if (filePath.toLowerCase().endsWith(ext)) {
          return ext;
        }
      }

      return '.mp3'; // Ø§Ù…ØªØ¯Ø§Ø¯ Ø§ÙØªØ±Ø§Ø¶ÙŠ
    }

    // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠÙ…
    function updatePagination(totalItems) {
      const totalPages = Math.ceil(totalItems / pageSize);

      document.getElementById('current-page').textContent = currentPage;
      document.getElementById('total-pages').textContent = totalPages;

      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙ†Ù‚Ù„
      document.getElementById('prev-page').disabled = currentPage <= 1;
      document.getElementById('next-page').disabled = currentPage >= totalPages;

      // ØªØ­Ø¯ÙŠØ« Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯
      document.getElementById('page-size').value = pageSize;
    }

    // ØªØºÙŠÙŠØ± Ø§Ù„ØµÙØ­Ø©
    function changePage(delta) {
      currentPage += delta;
      renderResponses(filteredResponses);
    }

    // ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø©
    function changePageSize() {
      pageSize = parseInt(document.getElementById('page-size').value);
      currentPage = 1; // Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø­Ø¬Ù… Ø§Ù„ØµÙØ­Ø©
      renderResponses(filteredResponses);
    }

    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ IDs
    function reorderAllIds() {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù€ IDsØŸ Ø³ÙŠØªÙ… ØªØ±ØªÙŠØ¨Ù‡Ø§ Ø¨Ø´ÙƒÙ„ ØªØ³Ù„Ø³Ù„ÙŠ Ù…Ù† 1.')) return;

      // Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ø±ØªØ¨Ø© Ù…Ù† Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
      const sortedResponses = [...allResponses].sort((a, b) =>
        new Date(a.timestamp) - new Date(b.timestamp)
      );

      // Ø¥Ù†Ø´Ø§Ø¡ Ù…ØµÙÙˆÙØ© Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª
      const updates = sortedResponses.map((response, index) => ({
        id: response.id,
        newId: index + 1
      }));

      // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«
      fetch('/api/reorder-ids', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ updates })
      })
      .then(response => {
        if (response.ok) {
          alert('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ù€ IDs Ø¨Ù†Ø¬Ø§Ø­!');
          loadResponses();
        } else {
          throw new Error('ÙØ´Ù„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ù€ IDs');
        }
      })
      .catch(error => {
        console.error('Error reordering IDs:', error);
        alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ±ØªÙŠØ¨ Ø§Ù„Ù€ IDs. Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ IDs Ù…Ø­Ù„ÙŠÙ‹Ø§.');

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ IDs Ù…Ø­Ù„ÙŠÙ‹Ø§ Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„Ø·Ù„Ø¨
        updateIdsLocally(updates);
      });
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ IDs Ù…Ø­Ù„ÙŠÙ‹Ø§
    function updateIdsLocally(updates) {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ IDs ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
      updates.forEach(update => {
        const response = allResponses.find(r => r.id === update.id);
        if (response) {
          response.id = update.newId;
        }
      });

      // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø¯ÙˆØ¯
      renderResponses(filteredResponses);

      alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ IDs Ù…Ø­Ù„ÙŠÙ‹Ø§. Ù‚Ø¯ ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ø±Ø¤ÙŠØ© Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª Ø¨Ø´ÙƒÙ„ ÙƒØ§Ù…Ù„.');
    }

    // ØªØµÙÙŠØ© Ø§Ù„Ø±Ø¯ÙˆØ¯
    function filterResponses() {
      const search = document.getElementById('search').value.toLowerCase();
      const filterDate = document.getElementById('filter-date').value;
      const filterQuestion = document.getElementById('filter-question').value;
      const filterMood = document.getElementById('filter-mood').value;

      let filtered = allResponses;

      // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ
      if (search) {
        filtered = filtered.filter(
          response =>
            response.question.toLowerCase().includes(search) ||
            response.answer.toLowerCase().includes(search) ||
            response.id.toString().includes(search)
        );
      }

      // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
      if (filterDate) {
        filtered = filtered.filter(response =>
          response.timestamp.startsWith(filterDate)
        );
      }

      // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¤Ø§Ù„
      if (filterQuestion) {
        filtered = filtered.filter(response =>
          response.question === filterQuestion
        );
      }

      // ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø²Ø§Ø¬
      if (filterMood) {
        filtered = filtered.filter(response => {
          if (filterMood === 'Ù…Ø¨Ø³ÙˆØ·Ù‡' && response.answer.includes('Ù…Ø¨Ø³ÙˆØ·Ù‡')) {
            return true;
          } else if (filterMood === 'Ù…ØªØ¶Ø§ÙŠÙ‚Ø©' && (response.answer.includes('Ù…ØªØ¶Ø§ÙŠÙ‚Ø©') || response.answer.includes('Ù…Ø´ Ù…Ø¨Ø³ÙˆØ·Ù‡'))) {
            return true;
          } else if (filterMood === 'ÙŠØ¹Ù†ÙŠ' && response.answer.includes('ÙŠØ¹Ù†ÙŠ Ø´ÙˆÙŠÙ‡')) {
            return true;
          }
          return false;
        });
      }

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„ÙÙ„ØªØ±
      currentPage = 1;

      // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…ØµÙØ§Ø©
      renderResponses(filtered);
    }

    // Ù…Ø³Ø­ Ø§Ù„ÙÙ„Ø§ØªØ±
    function clearFilters() {
      document.getElementById('search').value = '';
      document.getElementById('filter-date').value = '';
      document.getElementById('filter-question').value = '';
      document.getElementById('filter-mood').value = '';

      // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      currentPage = 1;

      renderResponses(allResponses);
    }

    // Ø­Ø°Ù Ø±Ø¯
    function deleteResponse(id) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø±Ø¯ØŸ')) return;

      fetch('/api/responses/' + id, { method: 'DELETE' })
        .then(res => {
          if (res.ok) {
            alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
            loadResponses();
          } else {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø±Ø¯.');
          }
        })
        .catch(error => {
          console.error('Error deleting response:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø±Ø¯.');
        });
    }

    // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¯ÙˆØ¯
    function deleteAllResponses() {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¯ÙˆØ¯ØŸ Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) return;

      fetch('/api/responses', { method: 'DELETE' })
        .then(res => {
          if (res.ok) {
            alert('ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­!');
            loadResponses();
          } else {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø±Ø¯ÙˆØ¯.');
          }
        })
        .catch(error => {
          console.error('Error deleting all responses:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø±Ø¯ÙˆØ¯.');
        });
    }

    // ÙØªØ­ Ù…Ø±Ø¨Ø¹ Ø­ÙˆØ§Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ«
    function openUpdateModal(id) {
      currentResponseId = id;

      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø±Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
      const response = allResponses.find(r => r.id === id);

      if (response) {
        // Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        document.getElementById('update-id').value = response.id;

        // Ù„Ø§ Ù†Ù…Ù„Ø£ Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…Ù„Ù ØµÙˆØªÙŠ
        if (!isAudioFile(response.answer)) {
          document.getElementById('update-answer').value = response.answer;
        } else {
          document.getElementById('update-answer').value = '';
          document.getElementById('update-answer').placeholder = 'ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ (Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡)';
        }

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ø­Ù‚Ù„ datetime-local
        const timestamp = new Date(response.timestamp);
        const formattedTimestamp = timestamp.toISOString().slice(0, 16);
        document.getElementById('update-timestamp').value = formattedTimestamp;
      }

      document.getElementById('updateModal').style.display = 'flex';
    }

    // Ø¥ØºÙ„Ø§Ù‚ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø­ÙˆØ§Ø±
    function closeModal() {
      document.getElementById('updateModal').style.display = 'none';
    }

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    function submitUpdate() {
      const newResponseId = document.getElementById('update-id').value;
      const newAnswer = document.getElementById('update-answer').value;
      const newTimestamp = document.getElementById('update-timestamp').value;

      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ø¯ÙŠØ«
      if (!newAnswer && !newTimestamp && !newResponseId) {
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ­Ø¯ÙŠØ«.');
        return;
      }

      // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
      const updateData = {};

      if (newResponseId) {
        updateData.id = newResponseId;
      }

      if (newAnswer) {
        updateData.answer = newAnswer;
      }

      if (newTimestamp) {
        updateData.timestamp = newTimestamp;
      }

      // Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ø¯ÙŠØ«
      fetch('/api/responses/' + currentResponseId, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(updateData)
      })
        .then(res => {
          if (res.ok) {
            alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­!');
            closeModal();
            loadResponses();
          } else {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¯.');
          }
        })
        .catch(error => {
          console.error('Error updating response:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø¯.');
        });
    }

    function exportToCSV() {
      const csvContent = "data:text/csv;charset=utf-8,"
        + allResponses.map(response => `${response.id},${response.question},${response.answer},${response.timestamp}`).join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "responses.csv");
      document.body.appendChild(link);
      link.click();
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    function updateStats() {
      const statsList = document.getElementById('stats-list');
      statsList.innerHTML = '';

      // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø¯ÙˆØ¯ Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„
      const questionCounts = allResponses.reduce((acc, response) => {
        acc[response.question] = (acc[response.question] || 0) + 1;
        return acc;
      }, {});

      // Ø­Ø³Ø§Ø¨ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø²Ø§Ø¬ Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„
      const questionMoods = {};

      uniqueQuestions.forEach(question => {
        questionMoods[question] = {
          'Ù…Ø¨Ø³ÙˆØ·Ø©': 0,
          'Ù…Ø­Ø§ÙŠØ¯Ø©': 0,
          'Ù…ØªØ¶Ø§ÙŠÙ‚Ø©': 0
        };
      });

      allResponses.forEach(response => {
        if (response.answer.includes('Ù…Ø¨Ø³ÙˆØ·Ù‡')) {
          questionMoods[response.question]['Ù…Ø¨Ø³ÙˆØ·Ø©']++;
        } else if (response.answer.includes('ÙŠØ¹Ù†ÙŠ Ø´ÙˆÙŠÙ‡')) {
          questionMoods[response.question]['Ù…Ø­Ø§ÙŠØ¯Ø©']++;
        } else if (response.answer.includes('Ù…ØªØ¶Ø§ÙŠÙ‚Ø©') || response.answer.includes('Ù…Ø´ Ù…Ø¨Ø³ÙˆØ·Ù‡')) {
          questionMoods[response.question]['Ù…ØªØ¶Ø§ÙŠÙ‚Ø©']++;
        }
      });

      // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
      for (const [question, count] of Object.entries(questionCounts)) {
        const li = document.createElement('li');

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
        const happy = questionMoods[question]['Ù…Ø¨Ø³ÙˆØ·Ø©'];
        const neutral = questionMoods[question]['Ù…Ø­Ø§ÙŠØ¯Ø©'];
        const sad = questionMoods[question]['Ù…ØªØ¶Ø§ÙŠÙ‚Ø©'];

        const happyPercent = Math.round((happy / count) * 100) || 0;
        const neutralPercent = Math.round((neutral / count) * 100) || 0;
        const sadPercent = Math.round((sad / count) * 100) || 0;

        li.innerHTML = `
          <strong>${question}</strong>: ${count} Ø¥Ø¬Ø§Ø¨Ø©
          <div style="display: flex; height: 10px; width: 100%; margin-top: 5px; border-radius: 5px; overflow: hidden;">
            <div style="width: ${happyPercent}%; background-color: rgba(0, 184, 148, 0.8);"></div>
            <div style="width: ${neutralPercent}%; background-color: rgba(253, 203, 110, 0.8);"></div>
            <div style="width: ${sadPercent}%; background-color: rgba(231, 76, 60, 0.8);"></div>
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 0.8em; margin-top: 2px;">
            <span>Ù…Ø¨Ø³ÙˆØ·Ø©: ${happyPercent}%</span>
            <span>Ù…Ø­Ø§ÙŠØ¯Ø©: ${neutralPercent}%</span>
            <span>Ù…ØªØ¶Ø§ÙŠÙ‚Ø©: ${sadPercent}%</span>
          </div>
        `;

        statsList.appendChild(li);
      }
    }

    // ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ CSV
    function exportToCSV() {
      // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø£Ø³ Ø§Ù„Ù…Ù„Ù
      const headers = ["ID", "Ø§Ù„Ø³Ø¤Ø§Ù„", "Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø©", "Ø§Ù„ØªØ§Ø±ÙŠØ®"];

      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ CSV
      const csvContent = "data:text/csv;charset=utf-8,"
        + headers.join(",") + "\n"
        + allResponses.map(response => {
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ÙÙˆØ§ØµÙ„
            let answer = response.answer;
            if (isAudioFile(answer)) {
              answer = "ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ";
            } else {
              // Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„ÙÙˆØ§ØµÙ„ Ø¨Ù…Ø³Ø§ÙØ§Øª Ù„ØªØ¬Ù†Ø¨ Ù…Ø´Ø§ÙƒÙ„ ØªÙ†Ø³ÙŠÙ‚ CSV
              answer = answer.replace(/,/g, " ");
            }

            return `${response.id},${response.question},${answer},${response.timestamp}`;
          }).join("\n");

      // Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ØªÙ†Ø²ÙŠÙ„
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", `Ø±Ø¯ÙˆØ¯_Ø§Ù„Ù…Ø²Ø§Ø¬_${new Date().toISOString().split('T')[0]}.csv`);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // Ø­Ø°Ù Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
    function deleteSelectedResponses() {
      const selected = Array.from(document.querySelectorAll('.select-response:checked')).map(cb => cb.value);

      if (selected.length === 0) {
        alert('Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙŠ Ø±Ø¯ÙˆØ¯.');
        return;
      }

      if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ${selected.length} Ø±Ø¯ Ù…Ø­Ø¯Ø¯ØŸ`)) return;

      Promise.all(selected.map(id => fetch('/api/responses/' + id, { method: 'DELETE' })))
        .then(() => {
          alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­!');
          loadResponses();
        })
        .catch(error => {
          console.error('Error deleting responses:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ø±Ø¯ÙˆØ¯.');
        });
    }

    // ØªØ­Ø¯ÙŠØ¯/Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø¯ÙˆØ¯
    function toggleSelectAll() {
      const checkboxes = document.querySelectorAll('.select-response');
      const selectAll = document.getElementById('select-all').checked;
      checkboxes.forEach(cb => cb.checked = selectAll);
    }



    // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙˆÙ‚Øª
    function formatTime(timeStr) {
      if (!timeStr) return '';

      // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª Ø¨ØªÙ†Ø³ÙŠÙ‚ "HH:MM:SS"ØŒ Ù†Ù‚ÙˆÙ… Ø¨ØªØ­ÙˆÙŠÙ„Ù‡ Ø¥Ù„Ù‰ "HH:MM"
      if (timeStr.length > 5) {
        return timeStr.substring(0, 5);
      }

      return timeStr;
    }

    // ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª
    function checkAudioFiles() {
      const statusContainer = document.getElementById('audio-status');
      statusContainer.innerHTML = '<p>Ø¬Ø§Ø±ÙŠ ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª...</p>';

      fetch('/api/check-audio-files')
        .then(res => res.json())
        .then(data => {
          const { totalAudioResponses, fileStatus } = data;

          // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          const missingFiles = fileStatus.filter(file => !file.exists);
          const hasBackup = fileStatus.filter(file => file.backup_exists);

          // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
          let statusHTML = `
            <div class="backup-stats">
              <div class="backup-stat">
                <h4>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª</h4>
                <div class="value">${totalAudioResponses}</div>
              </div>
              <div class="backup-stat">
                <h4>Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©</h4>
                <div class="value">${missingFiles.length}</div>
              </div>
              <div class="backup-stat">
                <h4>Ù„Ù‡Ø§ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h4>
                <div class="value">${hasBackup.length}</div>
              </div>
            </div>
          `;

          // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„Ø©
          if (missingFiles.length === 0) {
            statusHTML += `
              <div class="status-container status-success">
                <p>Ø¬Ù…ÙŠØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØ³Ù„ÙŠÙ…Ø©.</p>
              </div>
            `;
            document.getElementById('missing-files-container').style.display = 'none';
          } else {
            statusHTML += `
              <div class="status-container status-warning">
                <p>Ù‡Ù†Ø§Ùƒ ${missingFiles.length} Ù…Ù„Ù ØµÙˆØªÙŠ Ù…ÙÙ‚ÙˆØ¯. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ Ù…Ù† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©.</p>
              </div>
            `;

            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©
            document.getElementById('missing-files-container').style.display = 'block';
            const missingFilesTable = document.getElementById('missing-files');
            missingFilesTable.innerHTML = '';

            missingFiles.forEach(file => {
              const row = document.createElement('tr');
              const formattedDate = new Date(file.timestamp).toLocaleString('ar-EG');

              row.innerHTML = `
                <td>${file.id}</td>
                <td>${file.path}</td>
                <td>${formattedDate}</td>
                <td>${file.backup_exists ? 'Ù…ØªÙˆÙØ±Ø©' : 'ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©'}</td>
                <td>
                  ${file.backup_exists ?
                    `<button class="restore-btn" onclick="restoreAudioFile(${file.id})">Ø§Ø³ØªØ¹Ø§Ø¯Ø©</button>` :
                    'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©'}
                </td>
              `;

              missingFilesTable.appendChild(row);
            });
          }

          statusContainer.innerHTML = statusHTML;
        })
        .catch(error => {
          console.error('Error checking audio files:', error);
          statusContainer.innerHTML = `
            <div class="status-container status-error">
              <p>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ÙØ­Øµ Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
            </div>
          `;
        });
    }

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
    function loadBackups() {
      fetch('/api/backups')
        .then(res => res.json())
        .then(data => {
          const { total, backups } = data;

          const backupsList = document.getElementById('backups-list');
          backupsList.innerHTML = '';

          if (backups.length === 0) {
            backupsList.innerHTML = '<tr><td colspan="4" style="text-align: center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…ØªÙˆÙØ±Ø©</td></tr>';
            return;
          }

          backups.forEach(backup => {
            const row = document.createElement('tr');
            const formattedDate = new Date(backup.created).toLocaleString('ar-EG');
            const formattedSize = formatFileSize(backup.size);

            row.innerHTML = `
              <td>${backup.filename}</td>
              <td>${formattedSize}</td>
              <td>${formattedDate}</td>
              <td>
                <a href="${backup.path}" download class="download-btn">ØªØ­Ù…ÙŠÙ„</a>
              </td>
            `;

            backupsList.appendChild(row);
          });
        })
        .catch(error => {
          console.error('Error loading backups:', error);
          document.getElementById('backups-list').innerHTML =
            '<tr><td colspan="4" style="text-align: center;">Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</td></tr>';
        });
    }

    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù„Ù ØµÙˆØªÙŠ Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©
    function restoreAudioFile(id) {
      if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŸ')) return;

      fetch('/api/restore-audio/' + id, {
        method: 'POST'
      })
        .then(res => res.json())
        .then(data => {
          if (data.message) {
            alert('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­!');
            checkAudioFiles(); // Ø¥Ø¹Ø§Ø¯Ø© ÙØ­Øµ Ø§Ù„Ù…Ù„ÙØ§Øª
          } else {
            alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù„Ù: ' + data.error);
          }
        })
        .catch(error => {
          console.error('Error restoring audio file:', error);
          alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù…Ù„Ù');
        });
    }

    // ØªÙ†Ø³ÙŠÙ‚ Ø­Ø¬Ù… Ø§Ù„Ù…Ù„Ù
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';

      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));

      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
  </script>
</body>
</html>